<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能角色扮演</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 100px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .content {
            padding: 40px 20px;
        }

        .section-title {
            text-align: center;
            font-size: 2rem;
            color: #333;
            margin-bottom: 30px;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .character-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #4facfe;
        }

        .character-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
        }

        .character-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .character-category {
            color: #4facfe;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }

        .character-description {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 20px;
            height: 60px;
            overflow: hidden;
        }

        .character-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .chat-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        /* 聊天模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4facfe;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #28a745;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: #4facfe;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .message-input:focus {
            border-color: #4facfe;
        }

        .send-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-btn:hover {
            background: #3a8bfe;
        }

        .voice-btn {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .voice-status {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }

        .audio-controls {
            margin-top: 8px;
            text-align: center;
        }

        .play-audio-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-audio-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .characters-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .modal-content {
                width: 95%;
                height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🤖 AI智能角色扮演</h1>
            <p>与历史名人、科学家、文学家进行深度对话，探索不同的人生智慧与知识宝藏</p>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="characterCount">{{ character_count }}</span>
                    <span class="stat-label">精选角色</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">∞</span>
                    <span class="stat-label">对话次数</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">24/7</span>
                    <span class="stat-label">在线服务</span>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <h2 class="section-title">选择您的对话伙伴</h2>
            
            <div class="characters-grid">
                {% for character in characters %}
                <div class="character-card" onclick="startChat('{{ character.id }}', '{{ character.name }}')">
                    <div class="character-avatar">
                        {% if character.category == 'philosophy' %}🧠
                        {% elif character.category == 'science' %}🔬
                        {% elif character.category == 'literature' %}📚
                        {% elif character.category == 'fiction' %}🎭
                        {% else %}👤
                        {% endif %}
                    </div>
                    <div class="character-name">{{ character.name }}</div>
                    <div class="character-category">
                        {% if character.category == 'philosophy' %}哲学家
                        {% elif character.category == 'science' %}科学家
                        {% elif character.category == 'literature' %}文学家
                        {% elif character.category == 'fiction' %}虚拟角色
                        {% else %}其他
                        {% endif %}
                    </div>
                    <div class="character-description">{{ character.background[:100] }}...</div>
                    <div class="character-tags">
                        {% for tag in character.tags[:3] %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    <button class="chat-btn" onclick="event.stopPropagation(); startChat('{{ character.id }}', '{{ character.name }}')">
                        💬 开始对话
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 聊天模态框 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">与 AI助手 对话</div>
                <button class="close-btn" onclick="closeChat()">&times;</button>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="loading" id="loadingMessage">正在初始化对话...</div>
            </div>
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入您的消息或点击语音按钮..." maxlength="500">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">🎤</button>
                    <button class="send-btn" onclick="sendMessage()">发送</button>
                </div>
                <div class="voice-status" id="voiceStatus" style="display: none;">
                    <span id="voiceStatusText">准备录音</span>
                </div>
                <div class="voice-test-area" style="text-align: center; margin-top: 10px;">
                    <button class="voice-test-btn" onclick="testRecording()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        🔧 测试录音
                    </button>
                    <div id="testResult" style="margin-top: 8px; font-size: 0.8rem; color: #666;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket = null;
        let currentCharacter = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioPlayer = null;

        function startChat(characterId, characterName) {
            console.log('开始对话:', characterId, characterName);
            
            currentCharacter = characterId;
            document.getElementById('modalTitle').textContent = `与 ${characterName} 对话`;
            document.getElementById('chatContainer').innerHTML = '<div class="loading">正在连接...</div>';
            document.getElementById('chatModal').classList.add('show');
            
            // 初始化音频播放器
            if (!audioPlayer) {
                audioPlayer = document.createElement('audio');
                audioPlayer.controls = false;
            }
            
            // 初始化Socket.IO连接
            if (socket) {
                socket.disconnect();
            }
            
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socket连接成功');
                document.getElementById('chatContainer').innerHTML = `
                    <div class="message">
                        <div class="message-avatar">${getCharacterEmoji(characterId)}</div>
                        <div class="message-content">你好！我是${characterName}，很高兴与你交流。请问有什么我可以帮助你的吗？</div>
                    </div>
                `;
            });
            
            socket.on('chat_response', (data) => {
                console.log('收到AI回复:', data);
                addMessage(data.response, 'ai', data.character.name, data.audio_url);
            });
            
            socket.on('voice_message', (data) => {
                console.log('收到语音消息处理结果:', data);
            });
            
            socket.on('recognition_result', (data) => {
                console.log('语音识别结果:', data.text);
                document.getElementById('messageInput').value = data.text;
                updateVoiceStatus('识别完成: ' + data.text);
            });
            
            socket.on('ai_response', (data) => {
                console.log('AI文字回复:', data.text);
                addMessage(data.text, 'ai', characterName);
            });
            
            socket.on('tts_result', (data) => {
                console.log('收到语音合成结果');
                if (data.audio) {
                    playAudio(data.audio);
                }
            });
            
            socket.on('status', (data) => {
                updateVoiceStatus(data.message);
            });
            
            socket.on('error', (data) => {
                console.error('Socket错误:', data);
                addMessage('抱歉，出现了一些问题：' + data.message, 'system');
                updateVoiceStatus('错误: ' + data.message);
            });
            
            socket.on('disconnect', () => {
                console.log('Socket连接断开');
            });
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('show');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !socket || !currentCharacter) {
                return;
            }
            
            // 显示用户消息
            addMessage(message, 'user');
            input.value = '';
            
            // 发送到服务器
            socket.emit('chat_message', {
                message: message,
                character_id: currentCharacter
            });
        }

        function addMessage(content, sender, characterName = '', audioUrl = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let avatar = '';
            if (sender === 'user') {
                avatar = '👤';
            } else if (sender === 'system') {
                avatar = '⚠️';
            } else {
                avatar = getCharacterEmoji(currentCharacter);
            }
            
            let audioControls = '';
            if (sender === 'ai' && audioUrl) {
                audioControls = `
                    <div class="audio-controls">
                        <button class="play-audio-btn" onclick="playAudio('${audioUrl}')">
                            🔊 播放语音
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content}
                    ${audioControls}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // 如果是AI消息且有音频，自动播放
            if (sender === 'ai' && audioUrl) {
                setTimeout(() => {
                    playAudio(audioUrl);
                }, 500);
            }
        }

        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                console.log('🎤 开始Web Audio API录音...');
                updateVoiceStatus('正在请求麦克风权限...');
                
                // 请求麦克风权限，直接使用16kHz采样率
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,  // 直接使用16kHz匹配百度API
                        channelCount: 1,    // 单声道
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('✅ 麦克风权限获取成功，初始化Web Audio API...');
                
                // 创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                console.log('音频上下文采样率:', audioContext.sampleRate, 'Hz');
                
                // 创建音频源
                const source = audioContext.createMediaStreamSource(stream);
                
                // 创建ScriptProcessor来捕获音频数据
                const bufferSize = 4096;
                processor = audioContext.createScriptProcessor(bufferSize, 1, 1);
                
                // 初始化录音数据存储
                recordedSamples = [];
                
                processor.onaudioprocess = (event) => {
                    if (isRecording) {
                        const inputBuffer = event.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        // 复制音频数据
                        const samples = new Float32Array(inputData.length);
                        samples.set(inputData);
                        recordedSamples.push(samples);
                        
                        // 可选：实时音频级别监控
                        let maxLevel = 0;
                        for (let i = 0; i < samples.length; i++) {
                            maxLevel = Math.max(maxLevel, Math.abs(samples[i]));
                        }
                        
                        // 每隔一段时间更新状态
                        if (recordedSamples.length % 50 === 0) {
                            const duration = (recordedSamples.length * bufferSize) / 16000;
                            console.log(`录音中... ${duration.toFixed(1)}秒, 音频级别: ${maxLevel.toFixed(3)}`);
                        }
                    }
                };
                
                // 连接音频节点
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                // 存储stream以便后续清理
                currentStream = stream;
                
                // 开始录音
                isRecording = true;
                
                // 更新UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = '🛑';
                
                updateVoiceStatus('正在录音... 请说话，再次点击停止');
                console.log('✅ Web Audio API录音已开始');
                
                // 添加最小录音时间检查
                setTimeout(() => {
                    if (isRecording) {
                        updateVoiceStatus('继续录音中... 请确保说话声音清晰');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('录音失败:', error);
                updateVoiceStatus('无法访问麦克风: ' + error.message);
            }
        }

        async function stopRecording() {
            if (isRecording) {
                console.log('🛑 停止Web Audio API录音...');
                isRecording = false;
                
                // 停止音频处理
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                
                // 停止所有音频轨道
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // 关闭音频上下文
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // 更新UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = '🎤';
                
                updateVoiceStatus('处理录音中...');
                
                // 处理录音数据
                await processRecordedAudio();
            }
        }

        // 处理Web Audio API录制的音频数据
        async function processRecordedAudio() {
            try {
                console.log('📊 开始处理录音数据...');
                
                if (recordedSamples.length === 0) {
                    updateVoiceStatus('录音数据为空，请重新录音');
                    return;
                }

                // 合并所有音频样本
                let totalLength = 0;
                recordedSamples.forEach(samples => {
                    totalLength += samples.length;
                });

                console.log('录音统计:');
                console.log('- 数据块数量:', recordedSamples.length);
                console.log('- 总样本数:', totalLength);
                console.log('- 录音时长:', (totalLength / 16000).toFixed(2), '秒');

                // 检查录音长度
                const duration = totalLength / 16000;
                if (duration < 0.5) {
                    updateVoiceStatus('录音时间太短（少于0.5秒），请重新录音');
                    recordedSamples = [];
                    return;
                }

                if (duration > 30) {
                    updateVoiceStatus('录音时间太长（超过30秒），请录制较短的音频');
                    recordedSamples = [];
                    return;
                }

                // 合并音频数据
                const combinedSamples = new Float32Array(totalLength);
                let offset = 0;
                recordedSamples.forEach(samples => {
                    combinedSamples.set(samples, offset);
                    offset += samples.length;
                });

                // 检查音频质量
                let maxAmplitude = 0;
                let rmsSum = 0;
                for (let i = 0; i < combinedSamples.length; i++) {
                    const sample = Math.abs(combinedSamples[i]);
                    maxAmplitude = Math.max(maxAmplitude, sample);
                    rmsSum += sample * sample;
                }
                const rms = Math.sqrt(rmsSum / combinedSamples.length);

                console.log('音频质量分析:');
                console.log('- 最大振幅:', maxAmplitude.toFixed(4));
                console.log('- RMS值:', rms.toFixed(4));

                if (maxAmplitude < 0.001) {
                    updateVoiceStatus('检测到静音，请检查麦克风设置并重新录音');
                    recordedSamples = [];
                    return;
                }

                if (rms < 0.0001) {
                    updateVoiceStatus('音频信号太弱，请靠近麦克风或提高音量');
                    recordedSamples = [];
                    return;
                }

                // 创建WAV文件
                updateVoiceStatus('正在生成WAV文件...');
                const wavBlob = createWavBlob(combinedSamples, 16000);
                
                console.log('✅ WAV文件生成成功:');
                console.log('- 文件大小:', wavBlob.size, '字节');
                console.log('- 文件类型:', wavBlob.type);

                // 转换为base64并发送
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('📤 发送WAV数据到服务器...');
                    console.log('Base64长度:', audioBase64.length);

                    // 发送到服务器进行语音识别
                    socket.emit('voice_message', {
                        audio: audioBase64
                    });

                    updateVoiceStatus('正在识别语音...');
                };

                reader.onerror = () => {
                    updateVoiceStatus('音频数据读取失败');
                };

                reader.readAsDataURL(wavBlob);

                // 清理数据
                recordedSamples = [];

            } catch (error) {
                console.error('处理录音失败:', error);
                updateVoiceStatus('处理录音失败: ' + error.message);
                recordedSamples = [];
            }
        }

        // 创建WAV Blob
        function createWavBlob(samples, sampleRate) {
            const length = samples.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);

            // WAV文件头
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);                    // fmt chunk size
            view.setUint16(20, 1, true);                     // PCM format
            view.setUint16(22, 1, true);                     // mono
            view.setUint32(24, sampleRate, true);            // sample rate
            view.setUint32(28, sampleRate * 2, true);        // byte rate
            view.setUint16(32, 2, true);                     // block align
            view.setUint16(34, 16, true);                    // bits per sample
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);            // data size

            // 写入音频数据（16位PCM）
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, samples[i]));
                const intSample = Math.round(sample * 32767);
                view.setInt16(offset, intSample, true);
                offset += 2;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        async function processRecording() {
            try {
                if (audioChunks.length === 0) {
                    updateVoiceStatus('录音数据为空，请重新录音');
                    return;
                }
                
                const audioBlob = new Blob(audioChunks, { 
                    type: mediaRecorder.mimeType || 'audio/webm' 
                });
                
                console.log('录音处理完成');
                console.log('- 数据块数量:', audioChunks.length);
                console.log('- 总大小:', audioBlob.size, '字节');
                console.log('- MIME类型:', audioBlob.type);
                
                // 检查录音大小
                if (audioBlob.size < 1000) {
                    updateVoiceStatus('录音时间太短，请重新录音');
                    return;
                }
                
                if (audioBlob.size > 10 * 1024 * 1024) {
                    updateVoiceStatus('录音文件过大，请录制较短的音频');
                    return;
                }
                
                updateVoiceStatus('正在处理音频...');
                
                // 如果是WebM格式，尝试转换为WAV
                let finalBlob = audioBlob;
                if (audioBlob.type.includes('webm')) {
                    console.log('检测到WebM格式，尝试转换...');
                    try {
                        finalBlob = await convertWebMToWAV(audioBlob);
                        console.log('音频转换成功，新大小:', finalBlob.size);
                    } catch (convertError) {
                        console.warn('音频转换失败，使用原始格式:', convertError);
                        // 继续使用原始格式
                    }
                }
                
                // 转换为base64
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('发送语音数据到服务器...');
                    console.log('Base64长度:', audioBase64.length);
                    
                    // 发送到服务器进行语音识别
                    socket.emit('voice_message', {
                        audio: audioBase64
                    });
                    
                    updateVoiceStatus('正在识别语音...');
                };
                
                reader.onerror = () => {
                    updateVoiceStatus('音频数据读取失败');
                };
                
                reader.readAsDataURL(finalBlob);
                
            } catch (error) {
                console.error('处理录音失败:', error);
                updateVoiceStatus('处理录音失败: ' + error.message);
            }
        }

        // 简单的WebM到WAV转换函数
        async function convertWebMToWAV(webmBlob) {
            return new Promise((resolve, reject) => {
                try {
                    // 创建音频上下文
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // 读取WebM数据
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            // 解码音频数据
                            const audioBuffer = await audioContext.decodeAudioData(e.target.result);
                            
                            // 转换为WAV格式
                            const wavBlob = audioBufferToWav(audioBuffer);
                            resolve(wavBlob);
                        } catch (decodeError) {
                            console.error('音频解码失败:', decodeError);
                            reject(decodeError);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('文件读取失败'));
                    reader.readAsArrayBuffer(webmBlob);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 将AudioBuffer转换为WAV Blob
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const sampleRate = 16000; // 目标采样率
            const channels = 1; // 单声道
            
            // 重采样到16kHz
            const resampledBuffer = resampleBuffer(buffer, sampleRate);
            
            // 创建WAV文件
            const arrayBuffer = new ArrayBuffer(44 + resampledBuffer.length * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV文件头
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + resampledBuffer.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * channels * 2, true);
            view.setUint16(32, channels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, resampledBuffer.length * 2, true);
            
            // 写入音频数据
            let offset = 44;
            for (let i = 0; i < resampledBuffer.length; i++) {
                const sample = Math.max(-1, Math.min(1, resampledBuffer[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // 重采样函数
        function resampleBuffer(buffer, targetSampleRate) {
            if (buffer.sampleRate === targetSampleRate) {
                return buffer.getChannelData(0);
            }
            
            const sampleRateRatio = buffer.sampleRate / targetSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            const offsetResult = 0;
            let offsetBuffer = 0;
            
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0;
                let count = 0;
                
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer.getChannelData(0)[i];
                    count++;
                }
                
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            
            return result;
        }

        function playAudio(audioUrl) {
            try {
                console.log('播放音频:', audioUrl.substring(0, 50) + '...');
                
                // 停止当前播放的音频
                if (audioPlayer && !audioPlayer.paused) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                
                // 设置新的音频源
                audioPlayer.src = audioUrl;
                
                // 播放音频
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('音频播放开始');
                        updateVoiceStatus('正在播放语音...');
                    }).catch(error => {
                        console.error('音频播放失败:', error);
                        updateVoiceStatus('音频播放失败');
                    });
                }
                
                // 监听播放结束事件
                audioPlayer.onended = () => {
                    console.log('音频播放结束');
                    updateVoiceStatus('播放完成');
                };
                
            } catch (error) {
                console.error('播放音频时出错:', error);
                updateVoiceStatus('播放音频失败: ' + error.message);
            }
        }

        function updateVoiceStatus(message) {
            const statusDiv = document.getElementById('voiceStatus');
            const statusText = document.getElementById('voiceStatusText');
            
            if (statusDiv && statusText) {
                statusText.textContent = message;
                statusDiv.style.display = 'block';
                
                // 3秒后隐藏状态
                setTimeout(() => {
                    if (statusDiv.style.display === 'block') {
                        statusDiv.style.display = 'none';
                    }
                }, 3000);
            }
            
            console.log('语音状态:', message);
        }

        function getCharacterEmoji(characterId) {
            const emojis = {
                'socrates': '🧠',
                'einstein': '🔬',
                'shakespeare': '📚',
                'harry_potter': '🎭',
                'confucius': '🧠',
                'marie_curie': '🔬'
            };
            return emojis[characterId] || '🤖';
        }

        // 录音测试功能
        async function testRecording() {
            const testBtn = document.querySelector('.voice-test-btn');
            const testResult = document.getElementById('testResult');
            
            try {
                testBtn.textContent = '🔄 测试中...';
                testBtn.disabled = true;
                testResult.textContent = '正在测试麦克风权限...';
                testResult.style.color = '#007bff';
                
                // 1. 测试麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 44100,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                testResult.textContent = '✅ 麦克风权限正常，开始3秒录音测试...';
                
                // 2. 进行3秒录音测试
                let testMimeType = 'audio/wav';
                if (!MediaRecorder.isTypeSupported(testMimeType)) {
                    testMimeType = 'audio/webm;codecs=opus';
                }
                
                const testRecorder = new MediaRecorder(stream, { mimeType: testMimeType });
                const testChunks = [];
                
                testRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        testChunks.push(event.data);
                    }
                };
                
                testRecorder.onstop = async () => {
                    try {
                        const testBlob = new Blob(testChunks, { type: testMimeType });
                        
                        testResult.textContent = `✅ 录音测试完成！
                        📊 录音信息：
                        • 格式：${testMimeType}
                        • 大小：${(testBlob.size / 1024).toFixed(1)} KB
                        • 状态：${testBlob.size > 1000 ? '正常' : '可能太小'}
                        
                        💡 建议：
                        • 录音时说话要清晰响亮
                        • 避免环境噪音
                        • 录音时间建议3-8秒`;
                        
                        testResult.style.color = testBlob.size > 1000 ? '#28a745' : '#ffc107';
                        
                        // 停止所有音频轨道
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        testResult.textContent = `❌ 录音处理失败：${error.message}`;
                        testResult.style.color = '#dc3545';
                    }
                };
                
                // 开始录音
                testRecorder.start(100);
                
                // 3秒后停止
                setTimeout(() => {
                    if (testRecorder.state === 'recording') {
                        testRecorder.stop();
                    }
                }, 3000);
                
                // 显示倒计时
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    testResult.textContent = `🎤 录音测试中... ${countdown}秒`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        testResult.textContent = '🔄 处理录音数据...';
                    }
                }, 1000);
                
            } catch (error) {
                let errorMsg = '录音测试失败';
                if (error.name === 'NotAllowedError') {
                    errorMsg = '❌ 麦克风权限被拒绝\n请在浏览器设置中允许麦克风访问';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '❌ 未找到麦克风设备\n请检查设备连接';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = '❌ 浏览器不支持录音功能';
                }
                
                testResult.textContent = errorMsg;
                testResult.style.color = '#dc3545';
            } finally {
                testBtn.textContent = '🔧 测试录音';
                testBtn.disabled = false;
            }
        }

        // 回车发送消息
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 点击模态框外部关闭
        document.getElementById('chatModal').addEventListener('click', (e) => {
            if (e.target.id === 'chatModal') {
                closeChat();
            }
        });

        console.log('页面加载完成，角色数量:', {{ character_count }});
    </script>
</body>
</html>