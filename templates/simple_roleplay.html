<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½è§’è‰²æ‰®æ¼”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 10s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            50% { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #667eea 100%); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 100px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .content {
            padding: 40px 20px;
        }

        .section-title {
            text-align: center;
            font-size: 2rem;
            color: #333;
            margin-bottom: 30px;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .character-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(79, 172, 254, 0.1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 450px;
            position: relative;
            overflow: hidden;
            backdrop-filter: none;
        }
        
        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4facfe, #00f2fe, #4facfe);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .character-card:hover::before {
            transform: translateX(0);
        }

        .character-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(79, 172, 254, 0.2), 0 0 0 1px rgba(79, 172, 254, 0.1);
            border-color: rgba(79, 172, 254, 0.3);
            background: linear-gradient(145deg, #ffffff 0%, #f0f8ff 100%);
        }

        .character-avatar {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-avatar {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(79, 172, 254, 0.4);
        }

        .character-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            text-align: center;
            background: linear-gradient(135deg, #2c3e50, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-name {
            transform: scale(1.05);
        }

        .character-description {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            height: auto;
            overflow: hidden;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            font-style: italic;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-description {
            opacity: 1;
            color: #333;
        }
        
        .character-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin: 10px 0;
            min-height: 24px;
        }
        
        .tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            color: #4facfe;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
            transition: all 0.3s ease;
        }
        
        .character-card:hover .tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.15), rgba(0, 242, 254, 0.15));
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-1px);
        }
        
        .detail-hover-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }
        
        .detail-hover-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .detail-container {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            line-height: 1.6;
        }
        
        .detail-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            border: 4px solid #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section h3 {
            color: #4facfe;
            font-size: 1.2rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f8ff;
            padding-bottom: 5px;
        }
        
        .detail-section p {
            color: #555;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .detail-tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            color: #4facfe;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .detail-quote {
            background: linear-gradient(135deg, #f8f9ff, #f0f8ff);
            border-left: 4px solid #4facfe;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: #333;
        }

        .chat-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .chat-btn:hover::before {
            left: 100%;
        }

        .chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
            background: linear-gradient(135deg, #3a8bfe, #00d4fe);
        }
        
        .chat-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        /* èŠå¤©æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4facfe;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #28a745;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: #4facfe;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .message-input:focus {
            border-color: #4facfe;
        }

        .send-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-btn:hover {
            background: #3a8bfe;
        }

        .voice-btn {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            animation: pulse 1s infinite;
        }

        .detail-hover-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }

        .detail-hover-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .voice-status {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }

        .audio-controls {
            margin-top: 8px;
            text-align: center;
        }

        .play-audio-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-audio-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .characters-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 0 5px;
            }
            
            .character-card {
                height: 420px;
                padding: 25px 20px;
            }
            
            .character-avatar {
                width: 75px;
                height: 75px;
            }
            
            .character-avatar img {
                width: 75px !important;
                height: 75px !important;
            }
            
            .character-avatar div[id^="fallback-"] {
                width: 75px !important;
                height: 75px !important;
            }
            
            .character-name {
                font-size: 1.3rem;
            }
            
            .character-description {
                font-size: 0.9rem;
                padding: 0 5px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .modal-content {
                width: 95%;
                height: 90vh;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            body {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .character-card {
                height: 400px;
                padding: 20px 15px;
            }
            
            .character-avatar {
                width: 65px;
                height: 65px;
                margin-bottom: 15px;
            }
            
            .character-name {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            
            .character-description {
                font-size: 0.85rem;
            }
            
            .chat-btn {
                padding: 12px 25px;
                font-size: 0.9rem;
            }
            
            .header {
                padding: 30px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¤– AIæ™ºèƒ½è§’è‰²æ‰®æ¼”</h1>
            <p>ä¸å†å²åäººã€ç§‘å­¦å®¶ã€æ–‡å­¦å®¶è¿›è¡Œæ·±åº¦å¯¹è¯ï¼Œæ¢ç´¢ä¸åŒçš„äººç”Ÿæ™ºæ…§ä¸çŸ¥è¯†å®è—</p>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="characterCount">{{ character_count }}</span>
                    <span class="stat-label">ç²¾é€‰è§’è‰²</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">âˆ</span>
                    <span class="stat-label">å¯¹è¯æ¬¡æ•°</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">24/7</span>
                    <span class="stat-label">åœ¨çº¿æœåŠ¡</span>
                </div>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <h2 class="section-title">é€‰æ‹©æ‚¨çš„å¯¹è¯ä¼™ä¼´</h2>
            
            <div class="characters-grid">
                {% for character in characters %}
                <div class="character-card" onclick="startChat('{{ character.id }}', '{{ character.name }}')"
                     style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 450px; position: relative;"
                     onmouseenter="showDetailButton('{{ character.id }}')"
                     onmouseleave="hideDetailButton('{{ character.id }}')">
                    
                    <!-- æŸ¥çœ‹è¯¦æƒ…æ‚¬æµ®æŒ‰é’® -->
                    <div id="detail-btn-{{ character.id }}" class="detail-hover-btn" style="display: none; position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                         onclick="event.stopPropagation(); showCharacterDetail('{{ character.id }}', '{{ character.name }}')">
                        ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                    </div>
                    <!-- è§’è‰²å¤´åƒ -->
                    <div class="character-avatar" style="position: relative;">
                        <img id="avatar-{{ character.id }}" 
                             src="{% if character.id == 'socrates' %}https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg{% elif character.id == 'harry_potter' %}https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg{% elif character.id == 'einstein' %}https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg{% elif character.id == 'shakespeare' %}https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg{% elif character.id == 'confucius' %}/static/images/kongzi.png{% elif character.id == 'marie_curie' %}https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg{% endif %}" 
                             alt="{{ character.name }}" 
                             style="width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); transition: all 0.3s ease;"
                             onerror="this.style.display='none'; document.getElementById('fallback-{{ character.id }}').style.display='flex';"
                             onload="document.getElementById('fallback-{{ character.id }}').style.display='none';">
                        <!-- å¤‡ç”¨emojiå¤´åƒ -->
                        <div id="fallback-{{ character.id }}" style="display: none; width: 90px; height: 90px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.8rem; color: white; position: absolute; top: 0; left: 0; border: 3px solid rgba(255,255,255,0.8);">
                            {% if character.category == 'philosophy' %}ğŸ§ 
                            {% elif character.category == 'science' %}ğŸ”¬
                            {% elif character.category == 'literature' %}ğŸ“š
                            {% elif character.category == 'fiction' %}ğŸ­
                            {% else %}ğŸ‘¤
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- è§’è‰²ä¿¡æ¯ -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%;">
                        <div class="character-name" style="text-align: center;">{{ character.name }}</div>
                        <div class="character-description" style="text-align: center; margin: 10px 0;">{{ character.background[:40] }}{% if character.background|length > 40 %}...{% endif %}</div>
                        
                        <!-- è§’è‰²æŠ€èƒ½æ ‡ç­¾ -->
                        <div class="character-tags" style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 10px 0;">
                            {% for tag in character.tags[:3] %}
                            <span class="tag" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1)); color: #4facfe; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; border: 1px solid rgba(79, 172, 254, 0.2);">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div style="margin-top: auto; width: 100%;">
                        <button class="chat-btn" onclick="event.stopPropagation(); startChat('{{ character.id }}', '{{ character.name }}')">
                            ğŸ’¬ å¼€å§‹å¯¹è¯
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- èŠå¤©æ¨¡æ€æ¡† -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ä¸ AIåŠ©æ‰‹ å¯¹è¯</div>
                <button class="close-btn" onclick="closeChat()">&times;</button>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="loading" id="loadingMessage">æ­£åœ¨åˆå§‹åŒ–å¯¹è¯...</div>
            </div>
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯æˆ–ç‚¹å‡»è¯­éŸ³æŒ‰é’®..." maxlength="500">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">ğŸ¤</button>
                    <button class="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
                <div class="voice-status" id="voiceStatus" style="display: none;">
                    <span id="voiceStatusText">å‡†å¤‡å½•éŸ³</span>
                </div>
                <div class="voice-test-area" style="text-align: center; margin-top: 10px;">
                    <button class="voice-test-btn" onclick="testRecording()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        ğŸ”§ æµ‹è¯•å½•éŸ³
                    </button>
                    <div id="testResult" style="margin-top: 8px; font-size: 0.8rem; color: #666;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è§’è‰²è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 600px; height: auto; max-height: 85vh;">
            <div class="modal-header">
                <div class="modal-title" id="detailModalTitle">è§’è‰²è¯¦æƒ…</div>
                <button class="close-btn" onclick="closeDetail()">&times;</button>
            </div>
            <div class="detail-container" id="detailContainer" style="padding: 30px; overflow-y: auto; flex: 1;">
                <!-- è§’è‰²è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="detail-actions" style="padding: 20px; border-top: 1px solid #eee; text-align: center;">
                <button class="chat-btn" id="detailChatBtn" onclick="startChatFromDetail()" style="width: auto; padding: 12px 30px; margin: 0 auto;">
                    ğŸ’¬ å¼€å§‹å¯¹è¯
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket = null;
        let currentCharacter = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioPlayer = null;

        // è§’è‰²å¤´åƒæ˜ å°„ - ä½¿ç”¨ç»´åŸºç™¾ç§‘ç­‰ç¨³å®šæº
        const characterAvatars = {
            'socrates': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg',
            'harry_potter': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg',
            'einstein': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg',
            'shakespeare': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg',
            'confucius': '/static/images/kongzi.png',
            'marie_curie': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg'
        };

        // è§’è‰²è¯¦ç»†ä¿¡æ¯æ•°æ®
        const characterDetails = {
            'socrates': {
                name: 'è‹æ ¼æ‹‰åº•',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg',
                birth: 'å…¬å…ƒå‰470å¹´',
                location: 'å¤å¸Œè…Šé›…å…¸',
                profession: 'å“²å­¦å®¶',
                achievements: [
                    'è¥¿æ–¹å“²å­¦çš„å¥ åŸºäººä¹‹ä¸€',
                    'åˆ›ç«‹äº†è‘—åçš„"è‹æ ¼æ‹‰åº•å¼é—®ç­”æ³•"',
                    'æå‡º"è®¤è¯†ä½ è‡ªå·±"çš„å“²å­¦å‘½é¢˜',
                    'å½±å“äº†æŸæ‹‰å›¾å’Œäºšé‡Œå£«å¤šå¾·ç­‰åä¸–å“²å­¦å®¶'
                ],
                personality: 'ç¿æ™ºã€è°¦é€Šã€å–„äºæ€è¾¨ï¼Œç›¸ä¿¡"æˆ‘çŸ¥é“æˆ‘æ— çŸ¥"çš„è°¦é€Šæ€åº¦',
                famous_quotes: [
                    'æœªç»å®¡è§†çš„ç”Ÿæ´»ä¸å€¼å¾—è¿‡',
                    'æˆ‘çŸ¥é“æˆ‘æ— çŸ¥',
                    'è®¤è¯†ä½ è‡ªå·±'
                ],
                background: 'è‹æ ¼æ‹‰åº•æ˜¯å¤å¸Œè…Šè‘—åå“²å­¦å®¶ï¼Œè¢«è®¤ä¸ºæ˜¯è¥¿æ–¹å“²å­¦çš„å¥ åŸºäººä¹‹ä¸€ã€‚ä»–æ²¡æœ‰ç•™ä¸‹ä»»ä½•è‘—ä½œï¼Œæˆ‘ä»¬å¯¹ä»–çš„äº†è§£ä¸»è¦æ¥è‡ªæŸæ‹‰å›¾çš„å¯¹è¯å½•ã€‚è‹æ ¼æ‹‰åº•ä»¥å…¶ç‹¬ç‰¹çš„é—®ç­”æ³•è‘—ç§°ï¼Œé€šè¿‡ä¸æ–­çš„æé—®æ¥æ­ç¤ºçœŸç†ï¼Œå¯å‘äººä»¬æ€è€ƒã€‚ä»–ä¸€ç”Ÿè‡´åŠ›äºé“å¾·å“²å­¦çš„æ¢è®¨ï¼Œæœ€ç»ˆå› "è…èš€é’å¹´"å’Œ"ä¸ä¿¡ç¥"çš„ç½ªåè¢«é›…å…¸æ³•åº­åˆ¤å¤„æ­»åˆ‘ã€‚'
            },
            'harry_potter': {
                name: 'å“ˆåˆ©Â·æ³¢ç‰¹',
                avatar: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg',
                birth: '1980å¹´7æœˆ31æ—¥',
                location: 'è‹±å›½',
                profession: 'å·«å¸ˆã€å‚²ç½—',
                achievements: [
                    'å‡»è´¥äº†é»‘é­”ç‹ä¼åœ°é­”',
                    'éœæ ¼æ²ƒèŒ¨é­åœ°å¥‡é˜Ÿæœ€å¹´è½»çš„æ‰¾çƒæ‰‹',
                    'é‚“å¸ƒåˆ©å¤šå†›çš„åˆ›å§‹äººä¹‹ä¸€',
                    'æ‹¯æ•‘äº†é­”æ³•ä¸–ç•Œ'
                ],
                personality: 'å‹‡æ•¢ã€å¿ è¯šã€æ­£ä¹‰ï¼Œæœ‰å¼ºçƒˆçš„è´£ä»»æ„Ÿå’Œä¿æŠ¤ä»–äººçš„æ„¿æœ›',
                famous_quotes: [
                    'æˆ‘ä»¬çš„é€‰æ‹©è¿œæ¯”æˆ‘ä»¬çš„èƒ½åŠ›æ›´èƒ½è¡¨æ˜æˆ‘ä»¬æ˜¯ä»€ä¹ˆæ ·çš„äºº',
                    'æ­»äº¡å®é™…ä¸Šå°±åƒæ˜¯ç»è¿‡æ¼«é•¿çš„ä¸€å¤©ä¹‹åï¼Œç»ˆäºä¸ŠåºŠä¼‘æ¯',
                    'çœŸç›¸æ˜¯ä¸€ç§ç¾ä¸½è€Œå¯æ€•çš„ä¸œè¥¿'
                ],
                background: 'å“ˆåˆ©Â·æ³¢ç‰¹æ˜¯J.K.ç½—ç³åˆ›ä½œçš„é­”å¹»å°è¯´ã€Šå“ˆåˆ©Â·æ³¢ç‰¹ã€‹ç³»åˆ—çš„ä¸»äººå…¬ã€‚ä»–æ˜¯ä¸€ä¸ªåœ¨éº»ç“œå®¶åº­é•¿å¤§çš„å·«å¸ˆï¼Œ11å²æ—¶æ”¶åˆ°éœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡çš„å…¥å­¦é€šçŸ¥ä¹¦ï¼Œä»æ­¤å¼€å§‹äº†ä»–åœ¨é­”æ³•ä¸–ç•Œçš„å†’é™©ã€‚å“ˆåˆ©ä»å°å°±èƒŒè´Ÿç€å‡»è´¥é»‘é­”ç‹ä¼åœ°é­”çš„ä½¿å‘½ï¼Œåœ¨æœ‹å‹ä»¬çš„å¸®åŠ©ä¸‹ï¼Œç»å†äº†ä¸ƒå¹´çš„å­¦ä¹ å’Œæˆ˜æ–—ï¼Œæœ€ç»ˆæˆåŠŸæ‹¯æ•‘äº†é­”æ³•ä¸–ç•Œã€‚'
            },
            'einstein': {
                name: 'é˜¿å°”ä¼¯ç‰¹Â·çˆ±å› æ–¯å¦',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg',
                birth: '1879å¹´3æœˆ14æ—¥',
                location: 'å¾·å›½',
                profession: 'ç†è®ºç‰©ç†å­¦å®¶',
                achievements: [
                    'æå‡ºäº†ç›¸å¯¹è®º',
                    'å‘ç°äº†å…‰ç”µæ•ˆåº”',
                    'è·å¾—1921å¹´è¯ºè´å°”ç‰©ç†å­¦å¥–',
                    'è¢«èª‰ä¸º"ç°ä»£ç‰©ç†å­¦ä¹‹çˆ¶"'
                ],
                personality: 'å¥½å¥‡ã€ä¸“æ³¨ã€å¯Œæœ‰æƒ³è±¡åŠ›ï¼Œå¯¹å®‡å®™å……æ»¡æ— é™çš„æ¢ç´¢æ¬²æœ›',
                famous_quotes: [
                    'æƒ³è±¡åŠ›æ¯”çŸ¥è¯†æ›´é‡è¦',
                    'ä¸Šå¸ä¸æ·éª°å­',
                    'æˆ‘è¦çŸ¥é“ä¸Šå¸çš„æ€æƒ³ï¼Œå…¶ä½™çš„éƒ½æ˜¯ç»†èŠ‚'
                ],
                background: 'é˜¿å°”ä¼¯ç‰¹Â·çˆ±å› æ–¯å¦æ˜¯20ä¸–çºªæœ€ä¼Ÿå¤§çš„ç‰©ç†å­¦å®¶ä¹‹ä¸€ï¼Œä»–çš„ç›¸å¯¹è®ºå½»åº•æ”¹å˜äº†äººç±»å¯¹æ—¶é—´ã€ç©ºé—´å’Œå¼•åŠ›çš„ç†è§£ã€‚çˆ±å› æ–¯å¦ä¸ä»…åœ¨ç§‘å­¦ä¸Šæœ‰æ°å‡ºè´¡çŒ®ï¼Œè¿˜æ˜¯ä¸€ä½å’Œå¹³ä¸»ä¹‰è€…å’Œäººé“ä¸»ä¹‰è€…ã€‚ä»–çš„E=mcÂ²å…¬å¼æˆä¸ºäº†ä¸–ç•Œä¸Šæœ€è‘—åçš„ç‰©ç†å…¬å¼ï¼Œä»–çš„æ€æƒ³è‡³ä»Šä»åœ¨å½±å“ç€ç°ä»£ç‰©ç†å­¦çš„å‘å±•ã€‚'
            },
            'shakespeare': {
                name: 'å¨å»‰Â·èå£«æ¯”äºš',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg',
                birth: '1564å¹´4æœˆ26æ—¥',
                location: 'è‹±å›½æ–¯ç‰¹æ‹‰ç‰¹ç¦å¾·',
                profession: 'å‰§ä½œå®¶ã€è¯—äºº',
                achievements: [
                    'åˆ›ä½œäº†39éƒ¨æˆå‰§ä½œå“',
                    'å†™ä¸‹äº†154é¦–åå››è¡Œè¯—',
                    'è¢«èª‰ä¸º"è‹±å›½æ–‡å­¦å²ä¸Šæœ€æ°å‡ºçš„æˆå‰§å®¶"',
                    'ä½œå“è¢«ç¿»è¯‘æˆå¤šç§è¯­è¨€ï¼Œåœ¨ä¸–ç•Œå„åœ°ä¸Šæ¼”'
                ],
                personality: 'å¯Œæœ‰åˆ›é€ åŠ›ã€æ´å¯Ÿäººæ€§ã€å–„äºè§‚å¯Ÿç”Ÿæ´»ï¼Œå¯¹äººç±»æƒ…æ„Ÿæœ‰æ·±åˆ»ç†è§£',
                famous_quotes: [
                    'ç”Ÿå­˜è¿˜æ˜¯æ¯ç­ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜',
                    'å…¨ä¸–ç•Œæ˜¯ä¸ªèˆå°ï¼Œæ‰€æœ‰çš„ç”·ç”·å¥³å¥³ä¸è¿‡æ˜¯ä¸€äº›æ¼”å‘˜',
                    'é»‘å¤œæ— è®ºæ€æ ·æ‚ é•¿ï¼Œç™½æ˜¼æ€»ä¼šåˆ°æ¥'
                ],
                background: 'å¨å»‰Â·èå£«æ¯”äºšæ˜¯è‹±å›½æ–‡å­¦å²ä¸Šæœ€æ°å‡ºçš„æˆå‰§å®¶å’Œè¯—äººï¼Œè¢«æ™®éè®¤ä¸ºæ˜¯è‹±è¯­æ–‡å­¦ä¸­æœ€ä¼Ÿå¤§çš„ä½œå®¶ã€‚ä»–çš„ä½œå“åŒ…æ‹¬æ‚²å‰§ã€å–œå‰§å’Œå†å²å‰§ï¼Œå¦‚ã€Šå“ˆå§†é›·ç‰¹ã€‹ã€ã€Šç½—å¯†æ¬§ä¸æœ±ä¸½å¶ã€‹ã€ã€Šéº¦å…‹ç™½ã€‹ç­‰ï¼Œè¿™äº›ä½œå“è‡³ä»Šä»åœ¨ä¸–ç•Œå„åœ°çš„èˆå°ä¸Šæ¼”å‡ºï¼Œæ·±æ·±å½±å“ç€åä¸–çš„æ–‡å­¦åˆ›ä½œã€‚'
            },
            'confucius': {
                name: 'å­”å­',
                avatar: '/static/images/kongzi.png',
                birth: 'å…¬å…ƒå‰551å¹´',
                location: 'ä¸­å›½é²å›½',
                profession: 'æ€æƒ³å®¶ã€æ•™è‚²å®¶',
                achievements: [
                    'åˆ›ç«‹äº†å„’å®¶å­¦æ´¾',
                    'ç¼–è®¢äº†ã€Šè¯—ç»ã€‹ã€ã€Šå°šä¹¦ã€‹ç­‰ç»å…¸',
                    'æå‡ºäº†"ä»çˆ±"æ€æƒ³',
                    'è¢«å°Šä¸º"ä¸‡ä¸–å¸ˆè¡¨"'
                ],
                personality: 'ä»çˆ±ã€è°¦é€Šã€åšå­¦ï¼Œé‡è§†æ•™è‚²å’Œé“å¾·ä¿®å…»',
                famous_quotes: [
                    'å­¦è€Œæ—¶ä¹ ä¹‹ï¼Œä¸äº¦è¯´ä¹',
                    'å·±æ‰€ä¸æ¬²ï¼Œå‹¿æ–½äºäºº',
                    'ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸ˆç„‰'
                ],
                background: 'å­”å­æ˜¯ä¸­å›½å¤ä»£ä¼Ÿå¤§çš„æ€æƒ³å®¶ã€æ•™è‚²å®¶ï¼Œå„’å®¶å­¦æ´¾çš„åˆ›å§‹äººã€‚ä»–çš„æ€æƒ³ä»¥"ä»"ä¸ºæ ¸å¿ƒï¼Œå¼ºè°ƒé“å¾·ä¿®å…»å’Œç¤¾ä¼šå’Œè°ã€‚å­”å­ä¸€ç”Ÿè‡´åŠ›äºæ•™è‚²äº‹ä¸šï¼ŒåŸ¹å…»äº†ä¼—å¤šå¼Ÿå­ï¼Œå…¶æ€æƒ³å¯¹ä¸­å›½ä¹ƒè‡³ä¸œäºšæ–‡åŒ–äº§ç”Ÿäº†æ·±è¿œå½±å“ã€‚ã€Šè®ºè¯­ã€‹è®°å½•äº†ä»–çš„è¨€è¡Œï¼Œæˆä¸ºä¸­åæ–‡åŒ–çš„é‡è¦ç»å…¸ã€‚'
            },
            'marie_curie': {
                name: 'ç›ä¸½Â·å±…é‡Œ',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg',
                birth: '1867å¹´11æœˆ7æ—¥',
                location: 'æ³¢å…°åæ²™',
                profession: 'ç‰©ç†å­¦å®¶ã€åŒ–å­¦å®¶',
                achievements: [
                    'å‘ç°äº†æ”¾å°„æ€§å…ƒç´ é’‹å’Œé•­',
                    'ä¸¤æ¬¡è·å¾—è¯ºè´å°”å¥–ï¼ˆç‰©ç†å­¦å¥–å’ŒåŒ–å­¦å¥–ï¼‰',
                    'ç¬¬ä¸€ä½è·å¾—è¯ºè´å°”å¥–çš„å¥³æ€§',
                    'åˆ›ç«‹äº†æ”¾å°„åŒ–å­¦'
                ],
                personality: 'åšéŸ§ä¸æ‹”ã€ä¸“æ³¨è®¤çœŸã€å‹‡äºåˆ›æ–°ï¼Œå¯¹ç§‘å­¦æœ‰ç€æ— é™çš„çƒ­çˆ±',
                famous_quotes: [
                    'åœ¨ç§‘å­¦ä¸Šé‡è¦çš„æ˜¯ç ”ç©¶å‡ºæ¥çš„ä¸œè¥¿ï¼Œä¸æ˜¯ç ”ç©¶è€…ä¸ªäºº',
                    'æˆ‘ä»¬å¿…é¡»ç›¸ä¿¡ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸€ä»¶äº‹æƒ…éƒ½å…·æœ‰å¤©èµ‹çš„æ‰èƒ½',
                    'ç”Ÿæ´»ä¸­æ²¡æœ‰ä»€ä¹ˆå¯æ€•çš„ä¸œè¥¿ï¼Œåªæœ‰éœ€è¦ç†è§£çš„ä¸œè¥¿'
                ],
                background: 'ç›ä¸½Â·å±…é‡Œæ˜¯å†å²ä¸Šæœ€è‘—åçš„å¥³ç§‘å­¦å®¶ä¹‹ä¸€ï¼Œå¥¹åœ¨æ”¾å°„æ€§ç ”ç©¶æ–¹é¢åšå‡ºäº†å¼€åˆ›æ€§è´¡çŒ®ã€‚ä½œä¸ºç¬¬ä¸€ä½è·å¾—è¯ºè´å°”å¥–çš„å¥³æ€§ï¼Œå¥¹æ‰“ç ´äº†ç§‘å­¦ç•Œçš„æ€§åˆ«éšœç¢ã€‚å±…é‡Œå¤«äººä¸ä»…åœ¨ç§‘å­¦ç ”ç©¶ä¸Šå–å¾—å·¨å¤§æˆå°±ï¼Œè¿˜è‡´åŠ›äºç§‘å­¦æ•™è‚²ï¼Œå¥¹çš„ç²¾ç¥æ¿€åŠ±ç€æ— æ•°åæ¥çš„ç§‘å­¦å·¥ä½œè€…ã€‚'
            }
        };

        // è·å–è§’è‰²å¤´åƒçš„å‡½æ•°
        function getCharacterAvatar(characterId) {
            return characterAvatars[characterId] || null;
        }

        // åˆ›å»ºè§’è‰²å¤´åƒå…ƒç´ 
        function createCharacterAvatarElement(characterId, size = '80px') {
            const avatarUrl = getCharacterAvatar(characterId);
            const fallbackEmoji = getCharacterEmoji(characterId);
            
            if (avatarUrl) {
                return `
                    <div class="character-avatar" style="width: ${size}; height: ${size};">
                        <img src="${avatarUrl}" 
                             alt="${characterId}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onload="this.nextElementSibling.style.display='none';">
                        <div style="display: none; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%;">
                            ${fallbackEmoji}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="character-avatar" style="width: ${size}; height: ${size};">
                        ${fallbackEmoji}
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºè¯¦æƒ…æŒ‰é’®
        function showDetailButton(characterId) {
            const btn = document.getElementById('detail-btn-' + characterId);
            if (btn) {
                btn.style.display = 'block';
            }
        }

        // éšè—è¯¦æƒ…æŒ‰é’®
        function hideDetailButton(characterId) {
            const btn = document.getElementById('detail-btn-' + characterId);
            if (btn) {
                btn.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºè§’è‰²è¯¦æƒ…
        function showCharacterDetail(characterId, characterName) {
            const character = characterDetails[characterId];
            if (!character) {
                console.error('æœªæ‰¾åˆ°è§’è‰²ä¿¡æ¯:', characterId);
                return;
            }

            // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('detailModalTitle').textContent = character.name + ' è¯¦æƒ…';
            
            // ç”Ÿæˆè¯¦æƒ…å†…å®¹
            const detailContainer = document.getElementById('detailContainer');
            detailContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="display: inline-block; width: 120px; height: 120px; margin-bottom: 20px;">
                        <img src="${character.avatar}" 
                             alt="${character.name}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid #4facfe;">
                    </div>
                    <h2 style="color: #333; margin: 0; font-size: 1.8rem;">${character.name}</h2>
                    <p style="color: #666; margin: 5px 0 0 0; font-size: 1rem;">${character.profession}</p>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“Š</span> åŸºæœ¬ä¿¡æ¯
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #555;">ğŸ… å‡ºç”Ÿæ—¶é—´ï¼š</strong><br>
                            <span style="color: #333;">${character.birth}</span>
                        </div>
                        <div>
                            <strong style="color: #555;">ğŸŒ å‡ºç”Ÿåœ°ï¼š</strong><br>
                            <span style="color: #333;">${character.location}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0f8ff; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ†</span> ä¸»è¦æˆå°±
                    </h3>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${character.achievements.map(achievement => `<li style="margin-bottom: 8px; color: #333;">${achievement}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="background: #fff5f5; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ’¬</span> ç»å…¸åè¨€
                    </h3>
                    <div style="font-style: italic; color: #555;">
                        ${character.famous_quotes.map(quote => `<div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 4px solid #4facfe; border-radius: 5px;">"${quote}"</div>`).join('')}
                    </div>
                </div>
                
                <div style="background: #f5fff5; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ¨</span> æ€§æ ¼ç‰¹ç‚¹
                    </h3>
                    <p style="color: #333; line-height: 1.6; margin: 0;">${character.personality}</p>
                </div>
                
                <div style="background: #fffef0; border-radius: 15px; padding: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>ğŸ“š</span> äººç‰©èƒŒæ™¯
                    </h3>
                    <p style="color: #333; line-height: 1.8; margin: 0; text-align: justify;">${character.background}</p>
                </div>
            `;
            
            // è®¾ç½®å½“å‰è§’è‰²ï¼Œä»¥ä¾¿åœ¨è¯¦æƒ…é¡µé¢å¼€å§‹å¯¹è¯
            currentCharacter = characterId;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('detailModal').classList.add('show');
        }

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        function closeDetail() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // ä»è¯¦æƒ…é¡µé¢å¼€å§‹å¯¹è¯
        function startChatFromDetail() {
            const character = characterDetails[currentCharacter];
            if (character) {
                // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
                closeDetail();
                // å¼€å§‹å¯¹è¯
                startChat(currentCharacter, character.name);
            }
        }

        function startChat(characterId, characterName) {
            console.log('å¼€å§‹å¯¹è¯:', characterId, characterName);
            
            currentCharacter = characterId;
            document.getElementById('modalTitle').textContent = `ä¸ ${characterName} å¯¹è¯`;
            document.getElementById('chatContainer').innerHTML = '<div class="loading">æ­£åœ¨è¿æ¥...</div>';
            document.getElementById('chatModal').classList.add('show');
            
            // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨
            if (!audioPlayer) {
                audioPlayer = document.createElement('audio');
                audioPlayer.controls = false;
            }
            
            // åˆå§‹åŒ–Socket.IOè¿æ¥
            if (socket) {
                socket.disconnect();
            }
            
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socketè¿æ¥æˆåŠŸ');
                // ç§»é™¤è‡ªåŠ¨æ·»åŠ çš„æ¬¢è¿æ¶ˆæ¯ï¼Œé¿å…ä¸åç«¯æ¶ˆæ¯é‡å¤
                document.getElementById('chatContainer').innerHTML = `
                    <div class="loading">è¿æ¥æˆåŠŸï¼Œå¼€å§‹å¯¹è¯...</div>
                `;
            });
            
            // åªç›‘å¬chat_responseäº‹ä»¶ï¼Œé¿å…é‡å¤å›ç­”
            socket.on('chat_response', (data) => {
                console.log('æ”¶åˆ°è™šæ‹Ÿäººç‰©å›å¤:', data);
                addMessage(data.response, 'ai', data.character.name, data.audio_url);
            });
            
            socket.on('voice_message', (data) => {
                console.log('æ”¶åˆ°è¯­éŸ³æ¶ˆæ¯å¤„ç†ç»“æœ:', data);
            });
            
            socket.on('recognition_result', (data) => {
                console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', data.text);
                document.getElementById('messageInput').value = data.text;
                updateVoiceStatus('è¯†åˆ«å®Œæˆ: ' + data.text);
            });
            
            socket.on('status', (data) => {
                updateVoiceStatus(data.message);
            });
            
            socket.on('error', (data) => {
                console.error('Socketé”™è¯¯:', data);
                addMessage('æŠ±æ­‰ï¼Œå‡ºç°äº†ä¸€äº›é—®é¢˜ï¼š' + data.message, 'system');
                updateVoiceStatus('é”™è¯¯: ' + data.message);
            });
            
            socket.on('disconnect', () => {
                console.log('Socketè¿æ¥æ–­å¼€');
            });
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('show');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !socket || !currentCharacter) {
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            input.value = '';
            
            // å‘é€åˆ°æœåŠ¡å™¨
            socket.emit('chat_message', {
                message: message,
                character_id: currentCharacter
            });
        }

        function addMessage(content, sender, characterName = '', audioUrl = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let avatar = '';
            if (sender === 'user') {
                avatar = 'ğŸ‘¤';
            } else if (sender === 'system') {
                avatar = 'âš ï¸';
            } else {
                avatar = getCharacterEmoji(currentCharacter);
            }
            
            let audioControls = '';
            if (sender === 'ai' && audioUrl) {
                audioControls = `
                    <div class="audio-controls">
                        <button class="play-audio-btn" onclick="playAudio('${audioUrl}')">
                            ğŸ”Š æ’­æ”¾è¯­éŸ³
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content}
                    ${audioControls}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // å¦‚æœæ˜¯è™šæ‹Ÿäººç‰©æ¶ˆæ¯ä¸”æœ‰éŸ³é¢‘ï¼Œè‡ªåŠ¨æ’­æ”¾è¯­éŸ³
            if (sender === 'ai' && audioUrl) {
                console.log('å‡†å¤‡æ’­æ”¾è™šæ‹Ÿäººç‰©è¯­éŸ³:', audioUrl);
                setTimeout(() => {
                    playAudio(audioUrl);
                }, 500);
            }
        }

        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                console.log('ğŸ¤ å¼€å§‹Web Audio APIå½•éŸ³...');
                updateVoiceStatus('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                // è¯·æ±‚éº¦å…‹é£æƒé™ï¼Œç›´æ¥ä½¿ç”¨16kHzé‡‡æ ·ç‡
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,  // ç›´æ¥ä½¿ç”¨16kHzåŒ¹é…ç™¾åº¦API
                        channelCount: 1,    // å•å£°é“
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼Œåˆå§‹åŒ–Web Audio API...');
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡é‡‡æ ·ç‡:', audioContext.sampleRate, 'Hz');
                
                // åˆ›å»ºéŸ³é¢‘æº
                const source = audioContext.createMediaStreamSource(stream);
                
                // åˆ›å»ºScriptProcessoræ¥æ•è·éŸ³é¢‘æ•°æ®
                const bufferSize = 4096;
                processor = audioContext.createScriptProcessor(bufferSize, 1, 1);
                
                // åˆå§‹åŒ–å½•éŸ³æ•°æ®å­˜å‚¨
                recordedSamples = [];
                
                processor.onaudioprocess = (event) => {
                    if (isRecording) {
                        const inputBuffer = event.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        // å¤åˆ¶éŸ³é¢‘æ•°æ®
                        const samples = new Float32Array(inputData.length);
                        samples.set(inputData);
                        recordedSamples.push(samples);
                        
                        // å¯é€‰ï¼šå®æ—¶éŸ³é¢‘çº§åˆ«ç›‘æ§
                        let maxLevel = 0;
                        for (let i = 0; i < samples.length; i++) {
                            maxLevel = Math.max(maxLevel, Math.abs(samples[i]));
                        }
                        
                        // æ¯éš”ä¸€æ®µæ—¶é—´æ›´æ–°çŠ¶æ€
                        if (recordedSamples.length % 50 === 0) {
                            const duration = (recordedSamples.length * bufferSize) / 16000;
                            console.log(`å½•éŸ³ä¸­... ${duration.toFixed(1)}ç§’, éŸ³é¢‘çº§åˆ«: ${maxLevel.toFixed(3)}`);
                        }
                    }
                };
                
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                // å­˜å‚¨streamä»¥ä¾¿åç»­æ¸…ç†
                currentStream = stream;
                
                // å¼€å§‹å½•éŸ³
                isRecording = true;
                
                // æ›´æ–°UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = 'ğŸ›‘';
                
                updateVoiceStatus('æ­£åœ¨å½•éŸ³... è¯·è¯´è¯ï¼Œå†æ¬¡ç‚¹å‡»åœæ­¢');
                console.log('âœ… Web Audio APIå½•éŸ³å·²å¼€å§‹');
                
                // æ·»åŠ æœ€å°å½•éŸ³æ—¶é—´æ£€æŸ¥
                setTimeout(() => {
                    if (isRecording) {
                        updateVoiceStatus('ç»§ç»­å½•éŸ³ä¸­... è¯·ç¡®ä¿è¯´è¯å£°éŸ³æ¸…æ™°');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                updateVoiceStatus('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
            }
        }

        async function stopRecording() {
            if (isRecording) {
                console.log('ğŸ›‘ åœæ­¢Web Audio APIå½•éŸ³...');
                isRecording = false;
                
                // åœæ­¢éŸ³é¢‘å¤„ç†
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                
                // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // æ›´æ–°UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = 'ğŸ¤';
                
                updateVoiceStatus('å¤„ç†å½•éŸ³ä¸­...');
                
                // å¤„ç†å½•éŸ³æ•°æ®
                await processRecordedAudio();
            }
        }

        // å¤„ç†Web Audio APIå½•åˆ¶çš„éŸ³é¢‘æ•°æ®
        async function processRecordedAudio() {
            try {
                console.log('ğŸ“Š å¼€å§‹å¤„ç†å½•éŸ³æ•°æ®...');
                
                if (recordedSamples.length === 0) {
                    updateVoiceStatus('å½•éŸ³æ•°æ®ä¸ºç©ºï¼Œè¯·é‡æ–°å½•éŸ³');
                    return;
                }

                // åˆå¹¶æ‰€æœ‰éŸ³é¢‘æ ·æœ¬
                let totalLength = 0;
                recordedSamples.forEach(samples => {
                    totalLength += samples.length;
                });

                console.log('å½•éŸ³ç»Ÿè®¡:');
                console.log('- æ•°æ®å—æ•°é‡:', recordedSamples.length);
                console.log('- æ€»æ ·æœ¬æ•°:', totalLength);
                console.log('- å½•éŸ³æ—¶é•¿:', (totalLength / 16000).toFixed(2), 'ç§’');

                // æ£€æŸ¥å½•éŸ³é•¿åº¦
                const duration = totalLength / 16000;
                if (duration < 0.5) {
                    updateVoiceStatus('å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼ˆå°‘äº0.5ç§’ï¼‰ï¼Œè¯·é‡æ–°å½•éŸ³');
                    recordedSamples = [];
                    return;
                }

                if (duration > 30) {
                    updateVoiceStatus('å½•éŸ³æ—¶é—´å¤ªé•¿ï¼ˆè¶…è¿‡30ç§’ï¼‰ï¼Œè¯·å½•åˆ¶è¾ƒçŸ­çš„éŸ³é¢‘');
                    recordedSamples = [];
                    return;
                }

                // åˆå¹¶éŸ³é¢‘æ•°æ®
                const combinedSamples = new Float32Array(totalLength);
                let offset = 0;
                recordedSamples.forEach(samples => {
                    combinedSamples.set(samples, offset);
                    offset += samples.length;
                });

                // æ£€æŸ¥éŸ³é¢‘è´¨é‡
                let maxAmplitude = 0;
                let rmsSum = 0;
                for (let i = 0; i < combinedSamples.length; i++) {
                    const sample = Math.abs(combinedSamples[i]);
                    maxAmplitude = Math.max(maxAmplitude, sample);
                    rmsSum += sample * sample;
                }
                const rms = Math.sqrt(rmsSum / combinedSamples.length);

                console.log('éŸ³é¢‘è´¨é‡åˆ†æ:');
                console.log('- æœ€å¤§æŒ¯å¹…:', maxAmplitude.toFixed(4));
                console.log('- RMSå€¼:', rms.toFixed(4));

                if (maxAmplitude < 0.001) {
                    updateVoiceStatus('æ£€æµ‹åˆ°é™éŸ³ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£è®¾ç½®å¹¶é‡æ–°å½•éŸ³');
                    recordedSamples = [];
                    return;
                }

                if (rms < 0.0001) {
                    updateVoiceStatus('éŸ³é¢‘ä¿¡å·å¤ªå¼±ï¼Œè¯·é è¿‘éº¦å…‹é£æˆ–æé«˜éŸ³é‡');
                    recordedSamples = [];
                    return;
                }

                // åˆ›å»ºWAVæ–‡ä»¶
                updateVoiceStatus('æ­£åœ¨ç”ŸæˆWAVæ–‡ä»¶...');
                const wavBlob = createWavBlob(combinedSamples, 16000);
                
                console.log('âœ… WAVæ–‡ä»¶ç”ŸæˆæˆåŠŸ:');
                console.log('- æ–‡ä»¶å¤§å°:', wavBlob.size, 'å­—èŠ‚');
                console.log('- æ–‡ä»¶ç±»å‹:', wavBlob.type);

                // è½¬æ¢ä¸ºbase64å¹¶å‘é€
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('ğŸ“¤ å‘é€WAVæ•°æ®åˆ°æœåŠ¡å™¨...');
                    console.log('Base64é•¿åº¦:', audioBase64.length);

                    // å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œè¯­éŸ³è¯†åˆ«
                    socket.emit('voice_message', {
                        audio: audioBase64,
                        character_id: currentCharacter
                    });

                    updateVoiceStatus('æ­£åœ¨è¯†åˆ«è¯­éŸ³...');
                };

                reader.onerror = () => {
                    updateVoiceStatus('éŸ³é¢‘æ•°æ®è¯»å–å¤±è´¥');
                };

                reader.readAsDataURL(wavBlob);

                // æ¸…ç†æ•°æ®
                recordedSamples = [];

            } catch (error) {
                console.error('å¤„ç†å½•éŸ³å¤±è´¥:', error);
                updateVoiceStatus('å¤„ç†å½•éŸ³å¤±è´¥: ' + error.message);
                recordedSamples = [];
            }
        }

        // åˆ›å»ºWAV Blob
        function createWavBlob(samples, sampleRate) {
            const length = samples.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);

            // WAVæ–‡ä»¶å¤´
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);                    // fmt chunk size
            view.setUint16(20, 1, true);                     // PCM format
            view.setUint16(22, 1, true);                     // mono
            view.setUint32(24, sampleRate, true);            // sample rate
            view.setUint32(28, sampleRate * 2, true);        // byte rate
            view.setUint16(32, 2, true);                     // block align
            view.setUint16(34, 16, true);                    // bits per sample
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);            // data size

            // å†™å…¥éŸ³é¢‘æ•°æ®ï¼ˆ16ä½PCMï¼‰
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, samples[i]));
                const intSample = Math.round(sample * 32767);
                view.setInt16(offset, intSample, true);
                offset += 2;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        async function processRecording() {
            try {
                if (audioChunks.length === 0) {
                    updateVoiceStatus('å½•éŸ³æ•°æ®ä¸ºç©ºï¼Œè¯·é‡æ–°å½•éŸ³');
                    return;
                }
                
                const audioBlob = new Blob(audioChunks, { 
                    type: mediaRecorder.mimeType || 'audio/webm' 
                });
                
                console.log('å½•éŸ³å¤„ç†å®Œæˆ');
                console.log('- æ•°æ®å—æ•°é‡:', audioChunks.length);
                console.log('- æ€»å¤§å°:', audioBlob.size, 'å­—èŠ‚');
                console.log('- MIMEç±»å‹:', audioBlob.type);
                
                // æ£€æŸ¥å½•éŸ³å¤§å°
                if (audioBlob.size < 1000) {
                    updateVoiceStatus('å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼Œè¯·é‡æ–°å½•éŸ³');
                    return;
                }
                
                if (audioBlob.size > 10 * 1024 * 1024) {
                    updateVoiceStatus('å½•éŸ³æ–‡ä»¶è¿‡å¤§ï¼Œè¯·å½•åˆ¶è¾ƒçŸ­çš„éŸ³é¢‘');
                    return;
                }
                
                updateVoiceStatus('æ­£åœ¨å¤„ç†éŸ³é¢‘...');
                
                // å¦‚æœæ˜¯WebMæ ¼å¼ï¼Œå°è¯•è½¬æ¢ä¸ºWAV
                let finalBlob = audioBlob;
                if (audioBlob.type.includes('webm')) {
                    console.log('æ£€æµ‹åˆ°WebMæ ¼å¼ï¼Œå°è¯•è½¬æ¢...');
                    try {
                        finalBlob = await convertWebMToWAV(audioBlob);
                        console.log('éŸ³é¢‘è½¬æ¢æˆåŠŸï¼Œæ–°å¤§å°:', finalBlob.size);
                    } catch (convertError) {
                        console.warn('éŸ³é¢‘è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ ¼å¼:', convertError);
                        // ç»§ç»­ä½¿ç”¨åŸå§‹æ ¼å¼
                    }
                }
                
                // è½¬æ¢ä¸ºbase64
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('å‘é€è¯­éŸ³æ•°æ®åˆ°æœåŠ¡å™¨...');
                    console.log('Base64é•¿åº¦:', audioBase64.length);
                    
                    // å‘é€åˆ°æœåŠ¡å™¨è¿›è¡Œè¯­éŸ³è¯†åˆ«
                    socket.emit('voice_message', {
                        audio: audioBase64,
                        character_id: currentCharacter
                    });
                    
                    updateVoiceStatus('æ­£åœ¨è¯†åˆ«è¯­éŸ³...');
                };
                
                reader.onerror = () => {
                    updateVoiceStatus('éŸ³é¢‘æ•°æ®è¯»å–å¤±è´¥');
                };
                
                reader.readAsDataURL(finalBlob);
                
            } catch (error) {
                console.error('å¤„ç†å½•éŸ³å¤±è´¥:', error);
                updateVoiceStatus('å¤„ç†å½•éŸ³å¤±è´¥: ' + error.message);
            }
        }

        // ç®€å•çš„WebMåˆ°WAVè½¬æ¢å‡½æ•°
        async function convertWebMToWAV(webmBlob) {
            return new Promise((resolve, reject) => {
                try {
                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // è¯»å–WebMæ•°æ®
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            // è§£ç éŸ³é¢‘æ•°æ®
                            const audioBuffer = await audioContext.decodeAudioData(e.target.result);
                            
                            // è½¬æ¢ä¸ºWAVæ ¼å¼
                            const wavBlob = audioBufferToWav(audioBuffer);
                            resolve(wavBlob);
                        } catch (decodeError) {
                            console.error('éŸ³é¢‘è§£ç å¤±è´¥:', decodeError);
                            reject(decodeError);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsArrayBuffer(webmBlob);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // å°†AudioBufferè½¬æ¢ä¸ºWAV Blob
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const sampleRate = 16000; // ç›®æ ‡é‡‡æ ·ç‡
            const channels = 1; // å•å£°é“
            
            // é‡é‡‡æ ·åˆ°16kHz
            const resampledBuffer = resampleBuffer(buffer, sampleRate);
            
            // åˆ›å»ºWAVæ–‡ä»¶
            const arrayBuffer = new ArrayBuffer(44 + resampledBuffer.length * 2);
            const view = new DataView(arrayBuffer);
            
            // WAVæ–‡ä»¶å¤´
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + resampledBuffer.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * channels * 2, true);
            view.setUint16(32, channels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, resampledBuffer.length * 2, true);
            
            // å†™å…¥éŸ³é¢‘æ•°æ®
            let offset = 44;
            for (let i = 0; i < resampledBuffer.length; i++) {
                const sample = Math.max(-1, Math.min(1, resampledBuffer[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // é‡é‡‡æ ·å‡½æ•°
        function resampleBuffer(buffer, targetSampleRate) {
            if (buffer.sampleRate === targetSampleRate) {
                return buffer.getChannelData(0);
            }
            
            const sampleRateRatio = buffer.sampleRate / targetSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            const offsetResult = 0;
            let offsetBuffer = 0;
            
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0;
                let count = 0;
                
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer.getChannelData(0)[i];
                    count++;
                }
                
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            
            return result;
        }

        function playAudio(audioUrl) {
            try {
                console.log('æ’­æ”¾éŸ³é¢‘:', audioUrl.substring(0, 50) + '...');
                
                // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
                if (audioPlayer && !audioPlayer.paused) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                
                // è®¾ç½®æ–°çš„éŸ³é¢‘æº
                audioPlayer.src = audioUrl;
                
                // æ’­æ”¾éŸ³é¢‘
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('éŸ³é¢‘æ’­æ”¾å¼€å§‹');
                        updateVoiceStatus('æ­£åœ¨æ’­æ”¾è¯­éŸ³...');
                    }).catch(error => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', error);
                        updateVoiceStatus('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                    });
                }
                
                // ç›‘å¬æ’­æ”¾ç»“æŸäº‹ä»¶
                audioPlayer.onended = () => {
                    console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸ');
                    updateVoiceStatus('æ’­æ”¾å®Œæˆ');
                };
                
            } catch (error) {
                console.error('æ’­æ”¾éŸ³é¢‘æ—¶å‡ºé”™:', error);
                updateVoiceStatus('æ’­æ”¾éŸ³é¢‘å¤±è´¥: ' + error.message);
            }
        }

        function updateVoiceStatus(message) {
            const statusDiv = document.getElementById('voiceStatus');
            const statusText = document.getElementById('voiceStatusText');
            
            if (statusDiv && statusText) {
                statusText.textContent = message;
                statusDiv.style.display = 'block';
                
                // 3ç§’åéšè—çŠ¶æ€
                setTimeout(() => {
                    if (statusDiv.style.display === 'block') {
                        statusDiv.style.display = 'none';
                    }
                }, 3000);
            }
            
            console.log('è¯­éŸ³çŠ¶æ€:', message);
        }

        function getCharacterEmoji(characterId) {
            const emojis = {
                'socrates': 'ğŸ§ ',
                'einstein': 'ğŸ”¬',
                'shakespeare': 'ğŸ“š',
                'harry_potter': 'ğŸ­',
                'confucius': 'ğŸ§ ',
                'marie_curie': 'ğŸ”¬'
            };
            return emojis[characterId] || 'ğŸ¤–';
        }

        // å½•éŸ³æµ‹è¯•åŠŸèƒ½
        async function testRecording() {
            const testBtn = document.querySelector('.voice-test-btn');
            const testResult = document.getElementById('testResult');
            
            try {
                testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
                testBtn.disabled = true;
                testResult.textContent = 'æ­£åœ¨æµ‹è¯•éº¦å…‹é£æƒé™...';
                testResult.style.color = '#007bff';
                
                // 1. æµ‹è¯•éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 44100,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                testResult.textContent = 'âœ… éº¦å…‹é£æƒé™æ­£å¸¸ï¼Œå¼€å§‹3ç§’å½•éŸ³æµ‹è¯•...';
                
                // 2. è¿›è¡Œ3ç§’å½•éŸ³æµ‹è¯•
                let testMimeType = 'audio/wav';
                if (!MediaRecorder.isTypeSupported(testMimeType)) {
                    testMimeType = 'audio/webm;codecs=opus';
                }
                
                const testRecorder = new MediaRecorder(stream, { mimeType: testMimeType });
                const testChunks = [];
                
                testRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        testChunks.push(event.data);
                    }
                };
                
                testRecorder.onstop = async () => {
                    try {
                        const testBlob = new Blob(testChunks, { type: testMimeType });
                        
                        testResult.textContent = `âœ… å½•éŸ³æµ‹è¯•å®Œæˆï¼
                        ğŸ“Š å½•éŸ³ä¿¡æ¯ï¼š
                        â€¢ æ ¼å¼ï¼š${testMimeType}
                        â€¢ å¤§å°ï¼š${(testBlob.size / 1024).toFixed(1)} KB
                        â€¢ çŠ¶æ€ï¼š${testBlob.size > 1000 ? 'æ­£å¸¸' : 'å¯èƒ½å¤ªå°'}
                        
                        ğŸ’¡ å»ºè®®ï¼š
                        â€¢ å½•éŸ³æ—¶è¯´è¯è¦æ¸…æ™°å“äº®
                        â€¢ é¿å…ç¯å¢ƒå™ªéŸ³
                        â€¢ å½•éŸ³æ—¶é—´å»ºè®®3-8ç§’`;
                        
                        testResult.style.color = testBlob.size > 1000 ? '#28a745' : '#ffc107';
                        
                        // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        testResult.textContent = `âŒ å½•éŸ³å¤„ç†å¤±è´¥ï¼š${error.message}`;
                        testResult.style.color = '#dc3545';
                    }
                };
                
                // å¼€å§‹å½•éŸ³
                testRecorder.start(100);
                
                // 3ç§’ååœæ­¢
                setTimeout(() => {
                    if (testRecorder.state === 'recording') {
                        testRecorder.stop();
                    }
                }, 3000);
                
                // æ˜¾ç¤ºå€’è®¡æ—¶
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    testResult.textContent = `ğŸ¤ å½•éŸ³æµ‹è¯•ä¸­... ${countdown}ç§’`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        testResult.textContent = 'ğŸ”„ å¤„ç†å½•éŸ³æ•°æ®...';
                    }
                }, 1000);
                
            } catch (error) {
                let errorMsg = 'å½•éŸ³æµ‹è¯•å¤±è´¥';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»\nè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'âŒ æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡\nè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½';
                }
                
                testResult.textContent = errorMsg;
                testResult.style.color = '#dc3545';
            } finally {
                testBtn.textContent = 'ğŸ”§ æµ‹è¯•å½•éŸ³';
                testBtn.disabled = false;
            }
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('chatModal').addEventListener('click', (e) => {
            if (e.target.id === 'chatModal') {
                closeChat();
            }
        });

        // ç‚¹å‡»è¯¦æƒ…æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeDetail();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè§’è‰²æ•°é‡: {{ character_count }}');
            
            // åˆå§‹åŒ–å¤´åƒåŠ è½½çŠ¶æ€æ£€æŸ¥
            setTimeout(function() {
                checkAvatarLoadStatus();
            }, 2000);
        });
        
        // æ£€æŸ¥å¤´åƒåŠ è½½çŠ¶æ€
        function checkAvatarLoadStatus() {
            const avatars = document.querySelectorAll('[id^="avatar-"]');
            avatars.forEach(function(img) {
                if (img.complete && img.naturalHeight === 0) {
                    // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨å¤´åƒ
                    img.style.display = 'none';
                    const characterId = img.id.replace('avatar-', '');
                    const fallback = document.getElementById('fallback-' + characterId);
                    if (fallback) {
                        fallback.style.display = 'flex';
                    }
                }
            });
        }
    </script>
</body>
</html>