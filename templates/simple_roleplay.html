<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能角色扮演</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 20px;
            animation: gradientShift 10s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            50% { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 50%, #667eea 100%); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-width: 100px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .content {
            padding: 40px 20px;
        }

        .section-title {
            text-align: center;
            font-size: 2rem;
            color: #333;
            margin-bottom: 30px;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
            padding: 0 10px;
        }

        .character-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(79, 172, 254, 0.1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 450px;
            position: relative;
            overflow: hidden;
            backdrop-filter: none;
        }
        
        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4facfe, #00f2fe, #4facfe);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .character-card:hover::before {
            transform: translateX(0);
        }

        .character-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(79, 172, 254, 0.2), 0 0 0 1px rgba(79, 172, 254, 0.1);
            border-color: rgba(79, 172, 254, 0.3);
            background: linear-gradient(145deg, #ffffff 0%, #f0f8ff 100%);
        }

        .character-avatar {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: white;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-avatar {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(79, 172, 254, 0.4);
        }

        .character-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            text-align: center;
            background: linear-gradient(135deg, #2c3e50, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-name {
            transform: scale(1.05);
        }

        .character-description {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            height: auto;
            overflow: hidden;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            font-style: italic;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-description {
            opacity: 1;
            color: #333;
        }
        
        .character-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin: 10px 0;
            min-height: 24px;
        }
        
        .tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            color: #4facfe;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
            transition: all 0.3s ease;
        }
        
        .character-card:hover .tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.15), rgba(0, 242, 254, 0.15));
            border-color: rgba(79, 172, 254, 0.3);
            transform: translateY(-1px);
        }
        
        .detail-hover-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }
        
        .detail-hover-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .detail-container {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            line-height: 1.6;
        }
        
        .detail-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            border: 4px solid #4facfe;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }
        
        .detail-section {
            margin-bottom: 25px;
        }
        
        .detail-section h3 {
            color: #4facfe;
            font-size: 1.2rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f8ff;
            padding-bottom: 5px;
        }
        
        .detail-section p {
            color: #555;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .detail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .detail-tag {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            color: #4facfe;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .detail-quote {
            background: linear-gradient(135deg, #f8f9ff, #f0f8ff);
            border-left: 4px solid #4facfe;
            padding: 15px 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: #333;
        }

        .chat-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .chat-btn:hover::before {
            left: 100%;
        }

        .chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
            background: linear-gradient(135deg, #3a8bfe, #00d4fe);
        }
        
        .chat-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        /* 聊天模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4facfe;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #28a745;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 70%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: #4facfe;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
        }

        .message-input:focus {
            border-color: #4facfe;
        }

        .send-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .send-btn:hover {
            background: #3a8bfe;
        }

        .voice-btn {
            background: linear-gradient(135deg, #fa709a, #fee140);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .voice-btn:hover {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            transform: scale(1.05);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            animation: pulse 1s infinite;
        }

        .detail-hover-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: none;
            font-weight: 500;
        }

        .detail-hover-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .voice-status {
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 10px;
        }

        .audio-controls {
            margin-top: 8px;
            text-align: center;
        }

        .play-audio-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .play-audio-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .characters-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 0 5px;
            }
            
            .character-card {
                height: 420px;
                padding: 25px 20px;
            }
            
            .character-avatar {
                width: 75px;
                height: 75px;
            }
            
            .character-avatar img {
                width: 75px !important;
                height: 75px !important;
            }
            
            .character-avatar div[id^="fallback-"] {
                width: 75px !important;
                height: 75px !important;
            }
            
            .character-name {
                font-size: 1.3rem;
            }
            
            .character-description {
                font-size: 0.9rem;
                padding: 0 5px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .modal-content {
                width: 95%;
                height: 90vh;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            body {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .character-card {
                height: 400px;
                padding: 20px 15px;
            }
            
            .character-avatar {
                width: 65px;
                height: 65px;
                margin-bottom: 15px;
            }
            
            .character-name {
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            
            .character-description {
                font-size: 0.85rem;
            }
            
            .chat-btn {
                padding: 12px 25px;
                font-size: 0.9rem;
            }
            
            .header {
                padding: 30px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1>🤖 AI智能角色扮演</h1>
            <p>与历史名人、科学家、文学家进行深度对话，探索不同的人生智慧与知识宝藏</p>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="characterCount">{{ character_count }}</span>
                    <span class="stat-label">精选角色</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">∞</span>
                    <span class="stat-label">对话次数</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">24/7</span>
                    <span class="stat-label">在线服务</span>
                </div>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content">
            <h2 class="section-title">选择您的对话伙伴</h2>
            
            <div class="characters-grid">
                {% for character in characters %}
                <div class="character-card" onclick="startChat('{{ character.id }}', '{{ character.name }}')"
                     style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 450px; position: relative;"
                     onmouseenter="showDetailButton('{{ character.id }}')"
                     onmouseleave="hideDetailButton('{{ character.id }}')">
                    
                    <!-- 查看详情悬浮按钮 -->
                    <div id="detail-btn-{{ character.id }}" class="detail-hover-btn" style="display: none; position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s ease;"
                         onclick="event.stopPropagation(); showCharacterDetail('{{ character.id }}', '{{ character.name }}')">
                        📋 查看详情
                    </div>
                    <!-- 角色头像 -->
                    <div class="character-avatar" style="position: relative;">
                        <img id="avatar-{{ character.id }}" 
                             src="{% if character.id == 'socrates' %}https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg{% elif character.id == 'harry_potter' %}https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg{% elif character.id == 'einstein' %}https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg{% elif character.id == 'shakespeare' %}https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg{% elif character.id == 'confucius' %}/static/images/kongzi.png{% elif character.id == 'marie_curie' %}https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg{% endif %}" 
                             alt="{{ character.name }}" 
                             style="width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 3px solid rgba(255,255,255,0.8); transition: all 0.3s ease;"
                             onerror="this.style.display='none'; document.getElementById('fallback-{{ character.id }}').style.display='flex';"
                             onload="document.getElementById('fallback-{{ character.id }}').style.display='none';">
                        <!-- 备用emoji头像 -->
                        <div id="fallback-{{ character.id }}" style="display: none; width: 90px; height: 90px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.8rem; color: white; position: absolute; top: 0; left: 0; border: 3px solid rgba(255,255,255,0.8);">
                            {% if character.category == 'philosophy' %}🧠
                            {% elif character.category == 'science' %}🔬
                            {% elif character.category == 'literature' %}📚
                            {% elif character.category == 'fiction' %}🎭
                            {% else %}👤
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- 角色信息 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%;">
                        <div class="character-name" style="text-align: center;">{{ character.name }}</div>
                        <div class="character-description" style="text-align: center; margin: 10px 0;">{{ character.background[:40] }}{% if character.background|length > 40 %}...{% endif %}</div>
                        
                        <!-- 角色技能标签 -->
                        <div class="character-tags" style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 10px 0;">
                            {% for tag in character.tags[:3] %}
                            <span class="tag" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1)); color: #4facfe; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; border: 1px solid rgba(79, 172, 254, 0.2);">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="margin-top: auto; width: 100%;">
                        <button class="chat-btn" onclick="event.stopPropagation(); startChat('{{ character.id }}', '{{ character.name }}')">
                            💬 开始对话
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- 聊天模态框 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">与 AI助手 对话</div>
                <button class="close-btn" onclick="closeChat()">&times;</button>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="loading" id="loadingMessage">正在初始化对话...</div>
            </div>
            <div class="input-area">
                <div class="input-group">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入您的消息或点击语音按钮..." maxlength="500">
                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">🎤</button>
                    <button class="send-btn" onclick="sendMessage()">发送</button>
                </div>
                <div class="voice-status" id="voiceStatus" style="display: none;">
                    <span id="voiceStatusText">准备录音</span>
                </div>
                <div class="voice-test-area" style="text-align: center; margin-top: 10px;">
                    <button class="voice-test-btn" onclick="testRecording()" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        🔧 测试录音
                    </button>
                    <div id="testResult" style="margin-top: 8px; font-size: 0.8rem; color: #666;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色详情模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content" style="max-width: 600px; height: auto; max-height: 85vh;">
            <div class="modal-header">
                <div class="modal-title" id="detailModalTitle">角色详情</div>
                <button class="close-btn" onclick="closeDetail()">&times;</button>
            </div>
            <div class="detail-container" id="detailContainer" style="padding: 30px; overflow-y: auto; flex: 1;">
                <!-- 角色详情内容将在这里动态生成 -->
            </div>
            <div class="detail-actions" style="padding: 20px; border-top: 1px solid #eee; text-align: center;">
                <button class="chat-btn" id="detailChatBtn" onclick="startChatFromDetail()" style="width: auto; padding: 12px 30px; margin: 0 auto;">
                    💬 开始对话
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket = null;
        let currentCharacter = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let audioPlayer = null;

        // 角色头像映射 - 使用维基百科等稳定源
        const characterAvatars = {
            'socrates': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg',
            'harry_potter': 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg',
            'einstein': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg',
            'shakespeare': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg',
            'confucius': '/static/images/kongzi.png',
            'marie_curie': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg'
        };

        // 角色详细信息数据
        const characterDetails = {
            'socrates': {
                name: '苏格拉底',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a4/Socrates_Louvre.jpg/300px-Socrates_Louvre.jpg',
                birth: '公元前470年',
                location: '古希腊雅典',
                profession: '哲学家',
                achievements: [
                    '西方哲学的奠基人之一',
                    '创立了著名的"苏格拉底式问答法"',
                    '提出"认识你自己"的哲学命题',
                    '影响了柏拉图和亚里士多德等后世哲学家'
                ],
                personality: '睿智、谦逊、善于思辨，相信"我知道我无知"的谦逊态度',
                famous_quotes: [
                    '未经审视的生活不值得过',
                    '我知道我无知',
                    '认识你自己'
                ],
                background: '苏格拉底是古希腊著名哲学家，被认为是西方哲学的奠基人之一。他没有留下任何著作，我们对他的了解主要来自柏拉图的对话录。苏格拉底以其独特的问答法著称，通过不断的提问来揭示真理，启发人们思考。他一生致力于道德哲学的探讨，最终因"腐蚀青年"和"不信神"的罪名被雅典法庭判处死刑。'
            },
            'harry_potter': {
                name: '哈利·波特',
                avatar: 'https://upload.wikimedia.org/wikipedia/en/thumb/d/d7/Harry_Potter_character_poster.jpg/220px-Harry_Potter_character_poster.jpg',
                birth: '1980年7月31日',
                location: '英国',
                profession: '巫师、傲罗',
                achievements: [
                    '击败了黑魔王伏地魔',
                    '霍格沃茨魁地奇队最年轻的找球手',
                    '邓布利多军的创始人之一',
                    '拯救了魔法世界'
                ],
                personality: '勇敢、忠诚、正义，有强烈的责任感和保护他人的愿望',
                famous_quotes: [
                    '我们的选择远比我们的能力更能表明我们是什么样的人',
                    '死亡实际上就像是经过漫长的一天之后，终于上床休息',
                    '真相是一种美丽而可怕的东西'
                ],
                background: '哈利·波特是J.K.罗琳创作的魔幻小说《哈利·波特》系列的主人公。他是一个在麻瓜家庭长大的巫师，11岁时收到霍格沃茨魔法学校的入学通知书，从此开始了他在魔法世界的冒险。哈利从小就背负着击败黑魔王伏地魔的使命，在朋友们的帮助下，经历了七年的学习和战斗，最终成功拯救了魔法世界。'
            },
            'einstein': {
                name: '阿尔伯特·爱因斯坦',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg',
                birth: '1879年3月14日',
                location: '德国',
                profession: '理论物理学家',
                achievements: [
                    '提出了相对论',
                    '发现了光电效应',
                    '获得1921年诺贝尔物理学奖',
                    '被誉为"现代物理学之父"'
                ],
                personality: '好奇、专注、富有想象力，对宇宙充满无限的探索欲望',
                famous_quotes: [
                    '想象力比知识更重要',
                    '上帝不掷骰子',
                    '我要知道上帝的思想，其余的都是细节'
                ],
                background: '阿尔伯特·爱因斯坦是20世纪最伟大的物理学家之一，他的相对论彻底改变了人类对时间、空间和引力的理解。爱因斯坦不仅在科学上有杰出贡献，还是一位和平主义者和人道主义者。他的E=mc²公式成为了世界上最著名的物理公式，他的思想至今仍在影响着现代物理学的发展。'
            },
            'shakespeare': {
                name: '威廉·莎士比亚',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Shakespeare.jpg/300px-Shakespeare.jpg',
                birth: '1564年4月26日',
                location: '英国斯特拉特福德',
                profession: '剧作家、诗人',
                achievements: [
                    '创作了39部戏剧作品',
                    '写下了154首十四行诗',
                    '被誉为"英国文学史上最杰出的戏剧家"',
                    '作品被翻译成多种语言，在世界各地上演'
                ],
                personality: '富有创造力、洞察人性、善于观察生活，对人类情感有深刻理解',
                famous_quotes: [
                    '生存还是毁灭，这是一个问题',
                    '全世界是个舞台，所有的男男女女不过是一些演员',
                    '黑夜无论怎样悠长，白昼总会到来'
                ],
                background: '威廉·莎士比亚是英国文学史上最杰出的戏剧家和诗人，被普遍认为是英语文学中最伟大的作家。他的作品包括悲剧、喜剧和历史剧，如《哈姆雷特》、《罗密欧与朱丽叶》、《麦克白》等，这些作品至今仍在世界各地的舞台上演出，深深影响着后世的文学创作。'
            },
            'confucius': {
                name: '孔子',
                avatar: '/static/images/kongzi.png',
                birth: '公元前551年',
                location: '中国鲁国',
                profession: '思想家、教育家',
                achievements: [
                    '创立了儒家学派',
                    '编订了《诗经》、《尚书》等经典',
                    '提出了"仁爱"思想',
                    '被尊为"万世师表"'
                ],
                personality: '仁爱、谦逊、博学，重视教育和道德修养',
                famous_quotes: [
                    '学而时习之，不亦说乎',
                    '己所不欲，勿施于人',
                    '三人行，必有我师焉'
                ],
                background: '孔子是中国古代伟大的思想家、教育家，儒家学派的创始人。他的思想以"仁"为核心，强调道德修养和社会和谐。孔子一生致力于教育事业，培养了众多弟子，其思想对中国乃至东亚文化产生了深远影响。《论语》记录了他的言行，成为中华文化的重要经典。'
            },
            'marie_curie': {
                name: '玛丽·居里',
                avatar: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Marie_Curie_c._1920s.jpg/256px-Marie_Curie_c._1920s.jpg',
                birth: '1867年11月7日',
                location: '波兰华沙',
                profession: '物理学家、化学家',
                achievements: [
                    '发现了放射性元素钋和镭',
                    '两次获得诺贝尔奖（物理学奖和化学奖）',
                    '第一位获得诺贝尔奖的女性',
                    '创立了放射化学'
                ],
                personality: '坚韧不拔、专注认真、勇于创新，对科学有着无限的热爱',
                famous_quotes: [
                    '在科学上重要的是研究出来的东西，不是研究者个人',
                    '我们必须相信，我们对每一件事情都具有天赋的才能',
                    '生活中没有什么可怕的东西，只有需要理解的东西'
                ],
                background: '玛丽·居里是历史上最著名的女科学家之一，她在放射性研究方面做出了开创性贡献。作为第一位获得诺贝尔奖的女性，她打破了科学界的性别障碍。居里夫人不仅在科学研究上取得巨大成就，还致力于科学教育，她的精神激励着无数后来的科学工作者。'
            }
        };

        // 获取角色头像的函数
        function getCharacterAvatar(characterId) {
            return characterAvatars[characterId] || null;
        }

        // 创建角色头像元素
        function createCharacterAvatarElement(characterId, size = '80px') {
            const avatarUrl = getCharacterAvatar(characterId);
            const fallbackEmoji = getCharacterEmoji(characterId);
            
            if (avatarUrl) {
                return `
                    <div class="character-avatar" style="width: ${size}; height: ${size};">
                        <img src="${avatarUrl}" 
                             alt="${characterId}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                             onload="this.nextElementSibling.style.display='none';">
                        <div style="display: none; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%;">
                            ${fallbackEmoji}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="character-avatar" style="width: ${size}; height: ${size};">
                        ${fallbackEmoji}
                    </div>
                `;
            }
        }

        // 显示详情按钮
        function showDetailButton(characterId) {
            const btn = document.getElementById('detail-btn-' + characterId);
            if (btn) {
                btn.style.display = 'block';
            }
        }

        // 隐藏详情按钮
        function hideDetailButton(characterId) {
            const btn = document.getElementById('detail-btn-' + characterId);
            if (btn) {
                btn.style.display = 'none';
            }
        }

        // 显示角色详情
        function showCharacterDetail(characterId, characterName) {
            const character = characterDetails[characterId];
            if (!character) {
                console.error('未找到角色信息:', characterId);
                return;
            }

            // 设置模态框标题
            document.getElementById('detailModalTitle').textContent = character.name + ' 详情';
            
            // 生成详情内容
            const detailContainer = document.getElementById('detailContainer');
            detailContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="display: inline-block; width: 120px; height: 120px; margin-bottom: 20px;">
                        <img src="${character.avatar}" 
                             alt="${character.name}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 4px solid #4facfe;">
                    </div>
                    <h2 style="color: #333; margin: 0; font-size: 1.8rem;">${character.name}</h2>
                    <p style="color: #666; margin: 5px 0 0 0; font-size: 1rem;">${character.profession}</p>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>📊</span> 基本信息
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #555;">🎅 出生时间：</strong><br>
                            <span style="color: #333;">${character.birth}</span>
                        </div>
                        <div>
                            <strong style="color: #555;">🌍 出生地：</strong><br>
                            <span style="color: #333;">${character.location}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #f0f8ff; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>🏆</span> 主要成就
                    </h3>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${character.achievements.map(achievement => `<li style="margin-bottom: 8px; color: #333;">${achievement}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="background: #fff5f5; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>💬</span> 经典名言
                    </h3>
                    <div style="font-style: italic; color: #555;">
                        ${character.famous_quotes.map(quote => `<div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 4px solid #4facfe; border-radius: 5px;">"${quote}"</div>`).join('')}
                    </div>
                </div>
                
                <div style="background: #f5fff5; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>🎨</span> 性格特点
                    </h3>
                    <p style="color: #333; line-height: 1.6; margin: 0;">${character.personality}</p>
                </div>
                
                <div style="background: #fffef0; border-radius: 15px; padding: 20px;">
                    <h3 style="color: #4facfe; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                        <span>📚</span> 人物背景
                    </h3>
                    <p style="color: #333; line-height: 1.8; margin: 0; text-align: justify;">${character.background}</p>
                </div>
            `;
            
            // 设置当前角色，以便在详情页面开始对话
            currentCharacter = characterId;
            
            // 显示模态框
            document.getElementById('detailModal').classList.add('show');
        }

        // 关闭详情模态框
        function closeDetail() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // 从详情页面开始对话
        function startChatFromDetail() {
            const character = characterDetails[currentCharacter];
            if (character) {
                // 关闭详情模态框
                closeDetail();
                // 开始对话
                startChat(currentCharacter, character.name);
            }
        }

        function startChat(characterId, characterName) {
            console.log('开始对话:', characterId, characterName);
            
            currentCharacter = characterId;
            document.getElementById('modalTitle').textContent = `与 ${characterName} 对话`;
            document.getElementById('chatContainer').innerHTML = '<div class="loading">正在连接...</div>';
            document.getElementById('chatModal').classList.add('show');
            
            // 初始化音频播放器
            if (!audioPlayer) {
                audioPlayer = document.createElement('audio');
                audioPlayer.controls = false;
            }
            
            // 初始化Socket.IO连接
            if (socket) {
                socket.disconnect();
            }
            
            socket = io();
            
            socket.on('connect', () => {
                console.log('Socket连接成功');
                // 移除自动添加的欢迎消息，避免与后端消息重复
                document.getElementById('chatContainer').innerHTML = `
                    <div class="loading">连接成功，开始对话...</div>
                `;
            });
            
            // 只监听chat_response事件，避免重复回答
            socket.on('chat_response', (data) => {
                console.log('收到虚拟人物回复:', data);
                addMessage(data.response, 'ai', data.character.name, data.audio_url);
            });
            
            socket.on('voice_message', (data) => {
                console.log('收到语音消息处理结果:', data);
            });
            
            socket.on('recognition_result', (data) => {
                console.log('语音识别结果:', data.text);
                document.getElementById('messageInput').value = data.text;
                updateVoiceStatus('识别完成: ' + data.text);
            });
            
            socket.on('status', (data) => {
                updateVoiceStatus(data.message);
            });
            
            socket.on('error', (data) => {
                console.error('Socket错误:', data);
                addMessage('抱歉，出现了一些问题：' + data.message, 'system');
                updateVoiceStatus('错误: ' + data.message);
            });
            
            socket.on('disconnect', () => {
                console.log('Socket连接断开');
            });
        }

        function closeChat() {
            document.getElementById('chatModal').classList.remove('show');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !socket || !currentCharacter) {
                return;
            }
            
            // 显示用户消息
            addMessage(message, 'user');
            input.value = '';
            
            // 发送到服务器
            socket.emit('chat_message', {
                message: message,
                character_id: currentCharacter
            });
        }

        function addMessage(content, sender, characterName = '', audioUrl = null) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let avatar = '';
            if (sender === 'user') {
                avatar = '👤';
            } else if (sender === 'system') {
                avatar = '⚠️';
            } else {
                avatar = getCharacterEmoji(currentCharacter);
            }
            
            let audioControls = '';
            if (sender === 'ai' && audioUrl) {
                audioControls = `
                    <div class="audio-controls">
                        <button class="play-audio-btn" onclick="playAudio('${audioUrl}')">
                            🔊 播放语音
                        </button>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content}
                    ${audioControls}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            // 如果是虚拟人物消息且有音频，自动播放语音
            if (sender === 'ai' && audioUrl) {
                console.log('准备播放虚拟人物语音:', audioUrl);
                setTimeout(() => {
                    playAudio(audioUrl);
                }, 500);
            }
        }

        async function toggleVoiceRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                console.log('🎤 开始Web Audio API录音...');
                updateVoiceStatus('正在请求麦克风权限...');
                
                // 请求麦克风权限，直接使用16kHz采样率
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,  // 直接使用16kHz匹配百度API
                        channelCount: 1,    // 单声道
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('✅ 麦克风权限获取成功，初始化Web Audio API...');
                
                // 创建音频上下文
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                console.log('音频上下文采样率:', audioContext.sampleRate, 'Hz');
                
                // 创建音频源
                const source = audioContext.createMediaStreamSource(stream);
                
                // 创建ScriptProcessor来捕获音频数据
                const bufferSize = 4096;
                processor = audioContext.createScriptProcessor(bufferSize, 1, 1);
                
                // 初始化录音数据存储
                recordedSamples = [];
                
                processor.onaudioprocess = (event) => {
                    if (isRecording) {
                        const inputBuffer = event.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        // 复制音频数据
                        const samples = new Float32Array(inputData.length);
                        samples.set(inputData);
                        recordedSamples.push(samples);
                        
                        // 可选：实时音频级别监控
                        let maxLevel = 0;
                        for (let i = 0; i < samples.length; i++) {
                            maxLevel = Math.max(maxLevel, Math.abs(samples[i]));
                        }
                        
                        // 每隔一段时间更新状态
                        if (recordedSamples.length % 50 === 0) {
                            const duration = (recordedSamples.length * bufferSize) / 16000;
                            console.log(`录音中... ${duration.toFixed(1)}秒, 音频级别: ${maxLevel.toFixed(3)}`);
                        }
                    }
                };
                
                // 连接音频节点
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                // 存储stream以便后续清理
                currentStream = stream;
                
                // 开始录音
                isRecording = true;
                
                // 更新UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = '🛑';
                
                updateVoiceStatus('正在录音... 请说话，再次点击停止');
                console.log('✅ Web Audio API录音已开始');
                
                // 添加最小录音时间检查
                setTimeout(() => {
                    if (isRecording) {
                        updateVoiceStatus('继续录音中... 请确保说话声音清晰');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('录音失败:', error);
                updateVoiceStatus('无法访问麦克风: ' + error.message);
            }
        }

        async function stopRecording() {
            if (isRecording) {
                console.log('🛑 停止Web Audio API录音...');
                isRecording = false;
                
                // 停止音频处理
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                
                // 停止所有音频轨道
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                
                // 关闭音频上下文
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // 更新UI
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = '🎤';
                
                updateVoiceStatus('处理录音中...');
                
                // 处理录音数据
                await processRecordedAudio();
            }
        }

        // 处理Web Audio API录制的音频数据
        async function processRecordedAudio() {
            try {
                console.log('📊 开始处理录音数据...');
                
                if (recordedSamples.length === 0) {
                    updateVoiceStatus('录音数据为空，请重新录音');
                    return;
                }

                // 合并所有音频样本
                let totalLength = 0;
                recordedSamples.forEach(samples => {
                    totalLength += samples.length;
                });

                console.log('录音统计:');
                console.log('- 数据块数量:', recordedSamples.length);
                console.log('- 总样本数:', totalLength);
                console.log('- 录音时长:', (totalLength / 16000).toFixed(2), '秒');

                // 检查录音长度
                const duration = totalLength / 16000;
                if (duration < 0.5) {
                    updateVoiceStatus('录音时间太短（少于0.5秒），请重新录音');
                    recordedSamples = [];
                    return;
                }

                if (duration > 30) {
                    updateVoiceStatus('录音时间太长（超过30秒），请录制较短的音频');
                    recordedSamples = [];
                    return;
                }

                // 合并音频数据
                const combinedSamples = new Float32Array(totalLength);
                let offset = 0;
                recordedSamples.forEach(samples => {
                    combinedSamples.set(samples, offset);
                    offset += samples.length;
                });

                // 检查音频质量
                let maxAmplitude = 0;
                let rmsSum = 0;
                for (let i = 0; i < combinedSamples.length; i++) {
                    const sample = Math.abs(combinedSamples[i]);
                    maxAmplitude = Math.max(maxAmplitude, sample);
                    rmsSum += sample * sample;
                }
                const rms = Math.sqrt(rmsSum / combinedSamples.length);

                console.log('音频质量分析:');
                console.log('- 最大振幅:', maxAmplitude.toFixed(4));
                console.log('- RMS值:', rms.toFixed(4));

                if (maxAmplitude < 0.001) {
                    updateVoiceStatus('检测到静音，请检查麦克风设置并重新录音');
                    recordedSamples = [];
                    return;
                }

                if (rms < 0.0001) {
                    updateVoiceStatus('音频信号太弱，请靠近麦克风或提高音量');
                    recordedSamples = [];
                    return;
                }

                // 创建WAV文件
                updateVoiceStatus('正在生成WAV文件...');
                const wavBlob = createWavBlob(combinedSamples, 16000);
                
                console.log('✅ WAV文件生成成功:');
                console.log('- 文件大小:', wavBlob.size, '字节');
                console.log('- 文件类型:', wavBlob.type);

                // 转换为base64并发送
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('📤 发送WAV数据到服务器...');
                    console.log('Base64长度:', audioBase64.length);

                    // 发送到服务器进行语音识别
                    socket.emit('voice_message', {
                        audio: audioBase64,
                        character_id: currentCharacter
                    });

                    updateVoiceStatus('正在识别语音...');
                };

                reader.onerror = () => {
                    updateVoiceStatus('音频数据读取失败');
                };

                reader.readAsDataURL(wavBlob);

                // 清理数据
                recordedSamples = [];

            } catch (error) {
                console.error('处理录音失败:', error);
                updateVoiceStatus('处理录音失败: ' + error.message);
                recordedSamples = [];
            }
        }

        // 创建WAV Blob
        function createWavBlob(samples, sampleRate) {
            const length = samples.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);

            // WAV文件头
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);                    // fmt chunk size
            view.setUint16(20, 1, true);                     // PCM format
            view.setUint16(22, 1, true);                     // mono
            view.setUint32(24, sampleRate, true);            // sample rate
            view.setUint32(28, sampleRate * 2, true);        // byte rate
            view.setUint16(32, 2, true);                     // block align
            view.setUint16(34, 16, true);                    // bits per sample
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);            // data size

            // 写入音频数据（16位PCM）
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, samples[i]));
                const intSample = Math.round(sample * 32767);
                view.setInt16(offset, intSample, true);
                offset += 2;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        async function processRecording() {
            try {
                if (audioChunks.length === 0) {
                    updateVoiceStatus('录音数据为空，请重新录音');
                    return;
                }
                
                const audioBlob = new Blob(audioChunks, { 
                    type: mediaRecorder.mimeType || 'audio/webm' 
                });
                
                console.log('录音处理完成');
                console.log('- 数据块数量:', audioChunks.length);
                console.log('- 总大小:', audioBlob.size, '字节');
                console.log('- MIME类型:', audioBlob.type);
                
                // 检查录音大小
                if (audioBlob.size < 1000) {
                    updateVoiceStatus('录音时间太短，请重新录音');
                    return;
                }
                
                if (audioBlob.size > 10 * 1024 * 1024) {
                    updateVoiceStatus('录音文件过大，请录制较短的音频');
                    return;
                }
                
                updateVoiceStatus('正在处理音频...');
                
                // 如果是WebM格式，尝试转换为WAV
                let finalBlob = audioBlob;
                if (audioBlob.type.includes('webm')) {
                    console.log('检测到WebM格式，尝试转换...');
                    try {
                        finalBlob = await convertWebMToWAV(audioBlob);
                        console.log('音频转换成功，新大小:', finalBlob.size);
                    } catch (convertError) {
                        console.warn('音频转换失败，使用原始格式:', convertError);
                        // 继续使用原始格式
                    }
                }
                
                // 转换为base64
                const reader = new FileReader();
                reader.onloadend = () => {
                    const audioBase64 = reader.result;
                    console.log('发送语音数据到服务器...');
                    console.log('Base64长度:', audioBase64.length);
                    
                    // 发送到服务器进行语音识别
                    socket.emit('voice_message', {
                        audio: audioBase64,
                        character_id: currentCharacter
                    });
                    
                    updateVoiceStatus('正在识别语音...');
                };
                
                reader.onerror = () => {
                    updateVoiceStatus('音频数据读取失败');
                };
                
                reader.readAsDataURL(finalBlob);
                
            } catch (error) {
                console.error('处理录音失败:', error);
                updateVoiceStatus('处理录音失败: ' + error.message);
            }
        }

        // 简单的WebM到WAV转换函数
        async function convertWebMToWAV(webmBlob) {
            return new Promise((resolve, reject) => {
                try {
                    // 创建音频上下文
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // 读取WebM数据
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            // 解码音频数据
                            const audioBuffer = await audioContext.decodeAudioData(e.target.result);
                            
                            // 转换为WAV格式
                            const wavBlob = audioBufferToWav(audioBuffer);
                            resolve(wavBlob);
                        } catch (decodeError) {
                            console.error('音频解码失败:', decodeError);
                            reject(decodeError);
                        }
                    };
                    
                    reader.onerror = () => reject(new Error('文件读取失败'));
                    reader.readAsArrayBuffer(webmBlob);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 将AudioBuffer转换为WAV Blob
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const sampleRate = 16000; // 目标采样率
            const channels = 1; // 单声道
            
            // 重采样到16kHz
            const resampledBuffer = resampleBuffer(buffer, sampleRate);
            
            // 创建WAV文件
            const arrayBuffer = new ArrayBuffer(44 + resampledBuffer.length * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV文件头
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + resampledBuffer.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * channels * 2, true);
            view.setUint16(32, channels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, resampledBuffer.length * 2, true);
            
            // 写入音频数据
            let offset = 44;
            for (let i = 0; i < resampledBuffer.length; i++) {
                const sample = Math.max(-1, Math.min(1, resampledBuffer[i]));
                view.setInt16(offset, sample * 0x7FFF, true);
                offset += 2;
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // 重采样函数
        function resampleBuffer(buffer, targetSampleRate) {
            if (buffer.sampleRate === targetSampleRate) {
                return buffer.getChannelData(0);
            }
            
            const sampleRateRatio = buffer.sampleRate / targetSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            const offsetResult = 0;
            let offsetBuffer = 0;
            
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0;
                let count = 0;
                
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer.getChannelData(0)[i];
                    count++;
                }
                
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            
            return result;
        }

        function playAudio(audioUrl) {
            try {
                console.log('播放音频:', audioUrl.substring(0, 50) + '...');
                
                // 停止当前播放的音频
                if (audioPlayer && !audioPlayer.paused) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                
                // 设置新的音频源
                audioPlayer.src = audioUrl;
                
                // 播放音频
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('音频播放开始');
                        updateVoiceStatus('正在播放语音...');
                    }).catch(error => {
                        console.error('音频播放失败:', error);
                        updateVoiceStatus('音频播放失败');
                    });
                }
                
                // 监听播放结束事件
                audioPlayer.onended = () => {
                    console.log('音频播放结束');
                    updateVoiceStatus('播放完成');
                };
                
            } catch (error) {
                console.error('播放音频时出错:', error);
                updateVoiceStatus('播放音频失败: ' + error.message);
            }
        }

        function updateVoiceStatus(message) {
            const statusDiv = document.getElementById('voiceStatus');
            const statusText = document.getElementById('voiceStatusText');
            
            if (statusDiv && statusText) {
                statusText.textContent = message;
                statusDiv.style.display = 'block';
                
                // 3秒后隐藏状态
                setTimeout(() => {
                    if (statusDiv.style.display === 'block') {
                        statusDiv.style.display = 'none';
                    }
                }, 3000);
            }
            
            console.log('语音状态:', message);
        }

        function getCharacterEmoji(characterId) {
            const emojis = {
                'socrates': '🧠',
                'einstein': '🔬',
                'shakespeare': '📚',
                'harry_potter': '🎭',
                'confucius': '🧠',
                'marie_curie': '🔬'
            };
            return emojis[characterId] || '🤖';
        }

        // 录音测试功能
        async function testRecording() {
            const testBtn = document.querySelector('.voice-test-btn');
            const testResult = document.getElementById('testResult');
            
            try {
                testBtn.textContent = '🔄 测试中...';
                testBtn.disabled = true;
                testResult.textContent = '正在测试麦克风权限...';
                testResult.style.color = '#007bff';
                
                // 1. 测试麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 44100,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                testResult.textContent = '✅ 麦克风权限正常，开始3秒录音测试...';
                
                // 2. 进行3秒录音测试
                let testMimeType = 'audio/wav';
                if (!MediaRecorder.isTypeSupported(testMimeType)) {
                    testMimeType = 'audio/webm;codecs=opus';
                }
                
                const testRecorder = new MediaRecorder(stream, { mimeType: testMimeType });
                const testChunks = [];
                
                testRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        testChunks.push(event.data);
                    }
                };
                
                testRecorder.onstop = async () => {
                    try {
                        const testBlob = new Blob(testChunks, { type: testMimeType });
                        
                        testResult.textContent = `✅ 录音测试完成！
                        📊 录音信息：
                        • 格式：${testMimeType}
                        • 大小：${(testBlob.size / 1024).toFixed(1)} KB
                        • 状态：${testBlob.size > 1000 ? '正常' : '可能太小'}
                        
                        💡 建议：
                        • 录音时说话要清晰响亮
                        • 避免环境噪音
                        • 录音时间建议3-8秒`;
                        
                        testResult.style.color = testBlob.size > 1000 ? '#28a745' : '#ffc107';
                        
                        // 停止所有音频轨道
                        stream.getTracks().forEach(track => track.stop());
                        
                    } catch (error) {
                        testResult.textContent = `❌ 录音处理失败：${error.message}`;
                        testResult.style.color = '#dc3545';
                    }
                };
                
                // 开始录音
                testRecorder.start(100);
                
                // 3秒后停止
                setTimeout(() => {
                    if (testRecorder.state === 'recording') {
                        testRecorder.stop();
                    }
                }, 3000);
                
                // 显示倒计时
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    testResult.textContent = `🎤 录音测试中... ${countdown}秒`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        testResult.textContent = '🔄 处理录音数据...';
                    }
                }, 1000);
                
            } catch (error) {
                let errorMsg = '录音测试失败';
                if (error.name === 'NotAllowedError') {
                    errorMsg = '❌ 麦克风权限被拒绝\n请在浏览器设置中允许麦克风访问';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = '❌ 未找到麦克风设备\n请检查设备连接';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg = '❌ 浏览器不支持录音功能';
                }
                
                testResult.textContent = errorMsg;
                testResult.style.color = '#dc3545';
            } finally {
                testBtn.textContent = '🔧 测试录音';
                testBtn.disabled = false;
            }
        }

        // 回车发送消息
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 点击模态框外部关闭
        document.getElementById('chatModal').addEventListener('click', (e) => {
            if (e.target.id === 'chatModal') {
                closeChat();
            }
        });

        // 点击详情模态框外部关闭
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') {
                closeDetail();
            }
        });

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，角色数量: {{ character_count }}');
            
            // 初始化头像加载状态检查
            setTimeout(function() {
                checkAvatarLoadStatus();
            }, 2000);
        });
        
        // 检查头像加载状态
        function checkAvatarLoadStatus() {
            const avatars = document.querySelectorAll('[id^="avatar-"]');
            avatars.forEach(function(img) {
                if (img.complete && img.naturalHeight === 0) {
                    // 图片加载失败，显示备用头像
                    img.style.display = 'none';
                    const characterId = img.id.replace('avatar-', '');
                    const fallback = document.getElementById('fallback-' + characterId);
                    if (fallback) {
                        fallback.style.display = 'flex';
                    }
                }
            });
        }
    </script>
</body>
</html>